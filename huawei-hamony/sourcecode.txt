// FILE: build-profile.json5
{
  "app": {
    "signingConfigs": [],
    "products": [
      {
        "name": "default",
        "signingConfig": "default",
        "targetSdkVersion": "6.0.1(21)",
        "compatibleSdkVersion": "6.0.1(21)",
        "runtimeOS": "HarmonyOS",
        "buildOption": {
          "strictMode": {
            "caseSensitiveCheck": true,
            "useNormalizedOHMUrl": true
          }
        }
      }
    ],
    "buildModeSet": [
      {
        "name": "debug",
      },
      {
        "name": "release"
      }
    ]
  },
  "modules": [
    {
      "name": "entry",
      "srcPath": "./entry",
      "targets": [
        {
          "name": "default",
          "applyToProducts": [
            "default"
          ]
        }
      ]
    }
  ]
}// FILE: code-linter.json5
{
  "files": [
    "**/*.ets"
  ],
  "ignore": [
    "**/src/ohosTest/**/*",
    "**/src/test/**/*",
    "**/src/mock/**/*",
    "**/node_modules/**/*",
    "**/oh_modules/**/*",
    "**/build/**/*",
    "**/.preview/**/*"
  ],
  "ruleSet": [
    "plugin:@performance/recommended",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@security/no-unsafe-aes": "error",
    "@security/no-unsafe-hash": "error",
    "@security/no-unsafe-mac": "warn",
    "@security/no-unsafe-dh": "error",
    "@security/no-unsafe-dsa": "error",
    "@security/no-unsafe-ecdsa": "error",
    "@security/no-unsafe-rsa-encrypt": "error",
    "@security/no-unsafe-rsa-sign": "error",
    "@security/no-unsafe-rsa-key": "error",
    "@security/no-unsafe-dsa-key": "error",
    "@security/no-unsafe-dh-key": "error",
    "@security/no-unsafe-3des": "error"
  }
}// FILE: hvigorfile.ts
import { appTasks } from '@ohos/hvigor-ohos-plugin';
export default {
  system: appTasks, /* Built-in plugin of Hvigor. It cannot be modified. */
  plugins: []       /* Custom plugin to extend the functionality of Hvigor. */
}// FILE: oh-package-lock.json5
{
  "meta": {
    "stableOrder": true,
    "enableUnifiedLockfile": false
  },
  "lockfileVersion": 3,
  "ATTENTION": "THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.",
  "specifiers": {
    "@ohos/hamock@1.0.0": "@ohos/hamock@1.0.0",
    "@ohos/hypium@1.0.24": "@ohos/hypium@1.0.24"
  },
  "packages": {
    "@ohos/hamock@1.0.0": {
      "name": "@ohos/hamock",
      "version": "1.0.0",
      "integrity": "sha512-K6lDPYc6VkKe6ZBNQa9aoG+ZZMiwqfcR/7yAVFSUGIuOAhPvCJAo9+t1fZnpe0dBRBPxj2bxPPbKh69VuyAtDg==",
      "resolved": "https://repo.harmonyos.com/ohpm/@ohos/hamock/-/hamock-1.0.0.har",
      "registryType": "ohpm"
    },
    "@ohos/hypium@1.0.24": {
      "name": "@ohos/hypium",
      "version": "1.0.24",
      "integrity": "sha512-3dCqc+BAR5LqEGG2Vtzi8O3r7ci/3fYU+FWjwvUobbfko7DUnXGOccaror0yYuUhJfXzFK0aZNMGSnXaTwEnbw==",
      "resolved": "https://repo.harmonyos.com/ohpm/@ohos/hypium/-/hypium-1.0.24.har",
      "registryType": "ohpm"
    }
  }
}// FILE: oh-package.json5
{
  "modelVersion": "6.0.1",
  "description": "Please describe the basic information.",
  "dependencies": {
  },
  "devDependencies": {
    "@ohos/hypium": "1.0.24",
    "@ohos/hamock": "1.0.0"
  }
}
// FILE: package.json
{
  "name": "novel-creation-harmony",
  "version": "1.0.0",
  "description": "跨端 AI 创作 HarmonyOS 客户端",
  "scripts": {
    "build": "hvigor --mode module --product default",
    "dev": "hvigor --watch"
  },
  "devDependencies": {
    "@ohos/hvigor": "4.0.0",
    "@ohos/hvigor-ohos-plugin": "4.0.0"
  }
}
// FILE: entry/src/main/ets/components/MemoryCompassCard.ets
import { type NarrativeCompass, type CompassNode } from '../network/Services';
@Component
export default struct MemoryCompassCard {
  @Prop compass: NarrativeCompass;
  build() {
    Column({ space: 12 }) {
      Text(this.compass?.focus ?? '暂无焦点').fontSize(16).fontWeight(FontWeight.Medium);
      if (!this.compass || !this.compass.nodes || this.compass.nodes.length === 0) {
        Text('暂无记忆节点').fontSize(12).fontColor(0x999999);
      } else {
        ForEach(this.compass.nodes ?? [], (node: CompassNode, index: number) => this.renderNode(node, index), (_node: CompassNode, index: number) => `comp-${index}`);
      }
      if (this.compass?.last_updated) {
        Text(`更新于 ${this.compass.last_updated}`).fontSize(10).fontColor(0x999999);
      }
    }
    .padding(12)
    .backgroundColor(0xf7f7f9)
    .borderRadius(12);
  }
  @Builder
  renderNode(node: CompassNode, index: number) {
    Column({ space: 4 }) {
      Row({ space: 6 }) {
        Text(`#${index + 1} ${node.label}`).fontSize(14).fontWeight(FontWeight.Bold);
        Text(`情绪张力 ${this.formatScore(node.tension)}`).fontSize(10).fontColor(0x8a63ff);
        Text(`置信度 ${this.formatScore(node.confidence)}`).fontSize(10).fontColor(0x12b886);
      }
      Text(node.summary ?? '').fontSize(12).fontColor(0x444444);
    }
    .padding(10)
    .backgroundColor(0xffffff)
    .borderRadius(10);
  }
  formatScore(score?: number): string {
    const value = typeof score === 'number' ? Math.round(score * 100) / 100 : 0;
    return value.toFixed(2);
  }
}
// FILE: entry/src/main/ets/entryability/EntryAbility.ets
import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
const DOMAIN = 0x0000;
export default class EntryAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');
  }
  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }
  onWindowStageCreate(windowStage: window.WindowStage): void {
    // Main window is created, set main page for this ability
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');
    windowStage.loadContent('pages/HomePage', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the content.');
    });
  }
  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }
  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
  }
  onBackground(): void {
    // Ability has back to background
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onBackground');
  }
}
// FILE: entry/src/main/ets/entryability/EntryAbility.ts
import UIAbility from '@ohos.app.ability.UIAbility';
import window from '@ohos.window';
import abilityAccessCtrl, { PermissionRequestResult } from '@ohos.abilityAccessCtrl';
import promptAction from '@ohos.promptAction';
export default class EntryAbility extends UIAbility {
  onWindowStageCreate(windowStage: window.WindowStage) {
    windowStage.loadContent('pages/LoginPage', (err) => {
      if (err.code) {
        console.error('加载 LoginPage 失败: ' + JSON.stringify(err));
      }
    });
    this.ensureNetworkPermissions();
  }
  private async ensureNetworkPermissions(): Promise<void> {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const permissions: Array<string> = [
        'ohos.permission.INTERNET',
        'ohos.permission.GET_NETWORK_INFO'
      ];
      const grantStatus: PermissionRequestResult = await atManager.requestPermissionsFromUser(this.context, permissions);
      const denied = grantStatus.permissions.filter((_, index: number) => grantStatus.authResults[index] !== 0);
      if (denied.length > 0) {
        promptAction.showToast({ message: `权限未授予: ${denied.join(', ')}` });
      }
    } catch (err) {
      console.error('请求网络权限失败: ' + JSON.stringify(err));
    }
  }
}
// FILE: entry/src/main/ets/entrybackupability/EntryBackupAbility.ets
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BackupExtensionAbility, BundleVersion } from '@kit.CoreFileKit';
const DOMAIN = 0x0000;
export default class EntryBackupAbility extends BackupExtensionAbility {
  async onBackup() {
    hilog.info(DOMAIN, 'testTag', 'onBackup ok');
    await Promise.resolve();
  }
  async onRestore(bundleVersion: BundleVersion) {
    hilog.info(DOMAIN, 'testTag', 'onRestore ok %{public}s', JSON.stringify(bundleVersion));
    await Promise.resolve();
  }
}// FILE: entry/src/main/ets/network/ApiClient.ets
import http from '@ohos.net.http';
const API_TIMEOUT_MS: number = 5000 * 1000;
const DEFAULT_BASE_URL: string = 'http://127.0.0.1:23004/api/v1';
export interface HeaderEntry {
  key: string;
  value: string;
}
class HeaderObject {
  set(key: string, value: string): void {
    Reflect.set(this, key, value);
  }
}
export interface RequestOptions {
  method?: http.RequestMethod;
  data?: string | Object;
  headers?: Array<HeaderEntry>;
}
export class ApiClient {
  private baseUrl: string = DEFAULT_BASE_URL;
  private authToken: string = '';
  setBaseUrl(url: string): void {
    this.baseUrl = url || DEFAULT_BASE_URL;
  }
  setToken(token: string): void {
    this.authToken = token;
  }
  clearToken(): void {
    this.authToken = '';
  }
  get token(): string {
    return this.authToken;
  }
  async request<T>(path: string, options: RequestOptions = {}): Promise<T> {
    const method: http.RequestMethod = options.method ?? http.RequestMethod.GET;
    const headerEntries: Array<HeaderEntry> = [
      { key: 'Content-Type', value: 'application/json' }
    ];
    if (options.headers) {
      headerEntries.push(...options.headers);
    }
    if (this.authToken) {
      headerEntries.push({ key: 'Authorization', value: `Bearer ${this.authToken}` });
    }
    const headerObject: HeaderObject = new HeaderObject();
    headerEntries.forEach((entry: HeaderEntry) => headerObject.set(entry.key, entry.value));
    const httpRequest = http.createHttp();
    try {
      const extraData: string = typeof options.data === 'string'
        ? options.data
        : options.data
          ? JSON.stringify(options.data)
          : '';
      const response = await httpRequest.request(this.baseUrl + path, {
        method,
        connectTimeout: API_TIMEOUT_MS,
        readTimeout: API_TIMEOUT_MS,
        header: headerObject as Object,
        extraData
      });
      if (response.responseCode === 401) {
        this.clearToken();
        throw new Error('未授权，请先登录');
      }
      if (response.responseCode < 200 || response.responseCode >= 300) {
        const errorMessage = typeof response.result === 'string'
          ? response.result
          : '请求失败';
        if (typeof errorMessage === 'string' && errorMessage.toLowerCase().includes('permission')) {
          throw new Error('无权限访问，请先登录');
        }
        throw new Error(errorMessage);
      }
      const body = typeof response.result === 'string'
        ? response.result
        : JSON.stringify(response.result ?? {});
      return JSON.parse(body) as T;
    } finally {
      httpRequest.destroy();
    }
  }
}
export const apiClient: ApiClient = new ApiClient();
// FILE: entry/src/main/ets/network/Services.ets
import http from '@ohos.net.http';
import { apiClient, type RequestOptions } from './ApiClient';
export type ProjectStatus = 'created' | 'in_progress' | 'completed' | 'archived' | 'active';
interface ApiEnvelope<T> {
  data?: T;
  total?: number;
  projects?: Array<ProjectSummary>;
}
function unwrapResponse<T>(payload: T | ApiEnvelope<T>): T {
  const envelope = payload as ApiEnvelope<T>;
  if (envelope && envelope.data !== undefined) {
    return envelope.data;
  }
  return payload as T;
}
export interface RegisterPayload {
  username: string;
  email: string;
  password: string;
  nickname?: string;
}
export interface LoginPayload {
  username: string;
  password: string;
}
export interface LoginResponse {
  token: string;
  user: Object;
}
export interface ProjectSummary {
  project_id?: string;
  projectId?: string;
  project_name?: string;
  projectName?: string;
  first_idea?: string;
  firstIdea?: string;
  story_core?: string;
  status?: ProjectStatus;
}
export interface ProjectListParams {
  search?: string;
  status?: string;
  limit?: number;
}
export interface ProjectListResponse {
  projects?: Array<ProjectSummary>;
  total?: number;
}
export interface CreateProjectPayload {
  project_name: string;
  first_idea?: string;
}
interface BrainstormPayload {
  project_id: string;
  first_idea: string;
  num_ideas: number;
}
interface StoryCoreAdvancePayload {
  project_id: string;
  story_core: string;
}
interface ProtagonistPayload {
  project_id: string;
  leading_quantity: number;
}
interface PlotPayload {
  project_id: string;
}
interface BeatPayload {
  project_id: string;
  sequence_id: string;
}
interface ScriptVariablesPayload {
  project_id: string;
  current_seq_beats: Array<string>;
}
interface ScriptMetadataPayload {
  project_id: string;
}
interface ScriptGenerationPayload {
  template_name: string;
  variables: ScriptVariablesPayload;
  metadata: ScriptMetadataPayload;
}
interface PaymentOrderPayload {
  plan_id: string;
  channel: string;
}
interface NarrativeLinePayload {
  project_id: string;
  title: string;
  tone?: string;
  goal?: string;
}
interface NarrativeBeatPayload {
  project_id: string;
  line_id: string;
  prompt: string;
  word_preference?: string;
}
interface NarrativeMergePayload {
  project_id: string;
  target_line_id: string;
  source_line_id: string;
}
export interface NarrativeLine {
  line_id: string;
  title?: string;
  tone?: string;
  goal?: string;
  progress?: string;
  last_checkpoint?: string;
  tokens_used?: number;
}
export interface CompassNode {
  label: string;
  summary: string;
  confidence?: number;
  tension?: number;
}
export interface NarrativeCompass {
  focus?: string;
  nodes?: Array<CompassNode>;
  last_updated?: string;
}
export interface NarrativeLinesResponse {
  lines?: Array<NarrativeLine>;
  active_line_id?: string;
  compass?: NarrativeCompass;
  project_id?: string;
}
export interface NarrativeBeatResponse {
  content?: string;
  tokens_used?: number;
  line_id?: string;
  project_id?: string;
  compass?: NarrativeCompass;
}
export interface NarrativeMergeResponse {
  merged_to?: string;
  merged_from?: string;
  summary?: string;
  compass?: NarrativeCompass;
}
export interface TokenUsageEstimate {
  tokens: number;
  characters: number;
  estimated_cost_cny: number;
}
export interface AuthServiceInterface {
  register(payload: RegisterPayload): Promise<Object>;
  login(payload: LoginPayload): Promise<LoginResponse>;
  profile(): Promise<Object>;
}
class AuthServiceImpl implements AuthServiceInterface {
  async register(payload: RegisterPayload): Promise<Object> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/users/register', requestOptions);
    return unwrapResponse<Object>(data);
  }
  async login(payload: LoginPayload): Promise<LoginResponse> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<LoginResponse | ApiEnvelope<LoginResponse>>('/auth/login', requestOptions);
    const result = unwrapResponse<LoginResponse>(data);
    if (result.token) {
      apiClient.setToken(result.token);
    }
    return result;
  }
  async profile(): Promise<Object> {
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/auth/profile');
    return unwrapResponse<Object>(data);
  }
}
export const AuthService: AuthServiceInterface = new AuthServiceImpl();
function buildProjectQuery(params: ProjectListParams): string {
  const parts: Array<string> = [];
  if (params.search) {
    parts.push('search=' + encodeURIComponent(params.search));
  }
  if (params.status) {
    parts.push('status=' + encodeURIComponent(params.status));
  }
  const limitValue = params.limit ?? 20;
  parts.push('limit=' + encodeURIComponent(String(limitValue)));
  return parts.length > 0 ? `?${parts.join('&')}` : '';
}
function mapToProjectList(input: ProjectListResponse | Array<ProjectSummary>): ProjectListResponse {
  if (input instanceof Array) {
    const normalized: ProjectListResponse = { projects: input, total: input.length };
    return normalized;
  }
  return input as ProjectListResponse;
}
export interface ProjectServiceInterface {
  list(params?: ProjectListParams): Promise<ProjectListResponse>;
  create(payload: CreateProjectPayload): Promise<ProjectSummary>;
  update(projectId: string, payload: Object): Promise<ProjectSummary>;
  remove(projectId: string): Promise<void>;
  detail(projectId: string): Promise<ProjectSummary>;
}
class ProjectServiceImpl implements ProjectServiceInterface {
  async list(params?: ProjectListParams): Promise<ProjectListResponse> {
    const safeParams: ProjectListParams = params ?? {};
    const query = buildProjectQuery(safeParams);
    const data = await apiClient.request<ProjectListResponse | Array<ProjectSummary> | ApiEnvelope<ProjectListResponse>>(`/projects${query}`);
    const normalized = unwrapResponse<ProjectListResponse | Array<ProjectSummary>>(data);
    return mapToProjectList(normalized);
  }
  async create(payload: CreateProjectPayload): Promise<ProjectSummary> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<ProjectSummary | ApiEnvelope<ProjectSummary>>('/projects', requestOptions);
    return unwrapResponse<ProjectSummary>(data);
  }
  async update(projectId: string, payload: Object): Promise<ProjectSummary> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.PUT,
      data: payload
    };
    const data = await apiClient.request<ProjectSummary | ApiEnvelope<ProjectSummary>>(`/projects/${projectId}`, requestOptions);
    return unwrapResponse<ProjectSummary>(data);
  }
  async remove(projectId: string): Promise<void> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.DELETE
    };
    await apiClient.request<Object | ApiEnvelope<Object>>(`/projects/${projectId}`, requestOptions);
  }
  async detail(projectId: string): Promise<ProjectSummary> {
    const data = await apiClient.request<ProjectSummary | ApiEnvelope<ProjectSummary>>(`/projects/${projectId}`);
    return unwrapResponse<ProjectSummary>(data);
  }
}
export const ProjectService: ProjectServiceInterface = new ProjectServiceImpl();
export interface CreationServiceInterface {
  brainstorm(projectId: string, firstIdea: string): Promise<Object>;
  advanceStoryCore(projectId: string, storyCore: string): Promise<Object>;
  generateProtagonist(projectId: string): Promise<Object>;
  generateSupporting(projectId: string): Promise<Object>;
  generatePlot(projectId: string): Promise<Object>;
  generateBeats(projectId: string): Promise<Object>;
  generateScripts(projectId: string, beats: Array<string>): Promise<Object>;
}
class CreationServiceImpl implements CreationServiceInterface {
  async brainstorm(projectId: string, firstIdea: string): Promise<Object> {
    const payload: BrainstormPayload = { project_id: projectId, first_idea: firstIdea, num_ideas: 5 };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/llm/brainstorm', requestOptions);
    return unwrapResponse<Object>(data);
  }
  async advanceStoryCore(projectId: string, storyCore: string): Promise<Object> {
    const payload: StoryCoreAdvancePayload = { project_id: projectId, story_core: storyCore };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>(`/projects/${projectId}/story-core/advance`, requestOptions);
    return unwrapResponse<Object>(data);
  }
  async generateProtagonist(projectId: string): Promise<Object> {
    const payload: ProtagonistPayload = { project_id: projectId, leading_quantity: 1 };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/protagonist/generate', requestOptions);
    return unwrapResponse<Object>(data);
  }
  async generateSupporting(projectId: string): Promise<Object> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>(`/projects/${projectId}/generate/supporting`, requestOptions);
    return unwrapResponse<Object>(data);
  }
  async generatePlot(projectId: string): Promise<Object> {
    const payload: PlotPayload = { project_id: projectId };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/sequence-act/generate', requestOptions);
    return unwrapResponse<Object>(data);
  }
  async generateBeats(projectId: string): Promise<Object> {
    const payload: BeatPayload = { project_id: projectId, sequence_id: 'seq_main' };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/sequence-beat/generate', requestOptions);
    return unwrapResponse<Object>(data);
  }
  async generateScripts(projectId: string, beats: Array<string>): Promise<Object> {
    const payload: ScriptGenerationPayload = {
      template_name: 'sequence_scripts',
      variables: {
        project_id: projectId,
        current_seq_beats: beats
      },
      metadata: { project_id: projectId }
    };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/llm/generate-universal', requestOptions);
    return unwrapResponse<Object>(data);
  }
}
export const CreationService: CreationServiceInterface = new CreationServiceImpl();
export interface PointsServiceInterface {
  balance(): Promise<Object>;
  transactions(): Promise<Object>;
}
class PointsServiceImpl implements PointsServiceInterface {
  async balance(): Promise<Object> {
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/points/balance');
    return unwrapResponse<Object>(data);
  }
  async transactions(): Promise<Object> {
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/points/transactions');
    return unwrapResponse<Object>(data);
  }
}
export const PointsService: PointsServiceInterface = new PointsServiceImpl();
export interface PaymentsServiceInterface {
  listPlans(): Promise<Object>;
  createOrder(planId: string, channel: string): Promise<Object>;
}
class PaymentsServiceImpl implements PaymentsServiceInterface {
  async listPlans(): Promise<Object> {
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/payments/plans');
    return unwrapResponse<Object>(data);
  }
  async createOrder(planId: string, channel: string): Promise<Object> {
    const payload: PaymentOrderPayload = { plan_id: planId, channel };
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<Object | ApiEnvelope<Object>>('/payments/orders', requestOptions);
    return unwrapResponse<Object>(data);
  }
}
export const PaymentsService: PaymentsServiceInterface = new PaymentsServiceImpl();
export interface NarrativeServiceInterface {
  list(projectId: string): Promise<NarrativeLinesResponse>;
  createLine(payload: NarrativeLinePayload): Promise<NarrativeLine>;
  pushBeat(payload: NarrativeBeatPayload): Promise<NarrativeBeatResponse>;
  mergeLines(payload: NarrativeMergePayload): Promise<NarrativeMergeResponse>;
  fetchCompass(projectId: string): Promise<NarrativeCompass>;
}
class NarrativeServiceImpl implements NarrativeServiceInterface {
  async list(projectId: string): Promise<NarrativeLinesResponse> {
    const data = await apiClient.request<NarrativeLinesResponse | ApiEnvelope<NarrativeLinesResponse>>(`/projects/${projectId}/narratives/lines`);
    return unwrapResponse<NarrativeLinesResponse>(data);
  }
  async createLine(payload: NarrativeLinePayload): Promise<NarrativeLine> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<NarrativeLine | ApiEnvelope<NarrativeLine>>(`/projects/${payload.project_id}/narratives/lines`, requestOptions);
    return unwrapResponse<NarrativeLine>(data);
  }
  async pushBeat(payload: NarrativeBeatPayload): Promise<NarrativeBeatResponse> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<NarrativeBeatResponse | ApiEnvelope<NarrativeBeatResponse>>(`/projects/${payload.project_id}/narratives/lines/${payload.line_id}/beats`, requestOptions);
    return unwrapResponse<NarrativeBeatResponse>(data);
  }
  async mergeLines(payload: NarrativeMergePayload): Promise<NarrativeMergeResponse> {
    const requestOptions: RequestOptions = {
      method: http.RequestMethod.POST,
      data: payload
    };
    const data = await apiClient.request<NarrativeMergeResponse | ApiEnvelope<NarrativeMergeResponse>>(`/projects/${payload.project_id}/narratives/merge`, requestOptions);
    return unwrapResponse<NarrativeMergeResponse>(data);
  }
  async fetchCompass(projectId: string): Promise<NarrativeCompass> {
    const data = await apiClient.request<NarrativeCompass | ApiEnvelope<NarrativeCompass>>(`/projects/${projectId}/narratives/compass`);
    return unwrapResponse<NarrativeCompass>(data);
  }
}
export const NarrativeService: NarrativeServiceInterface = new NarrativeServiceImpl();
export class TokenEstimator {
  static estimate(texts: Array<string>, pricePerKTokenCny: number = 0.12): TokenUsageEstimate {
    const characters = texts.reduce((acc: number, item: string) => acc + (item?.length ?? 0), 0);
    const tokens = Math.max(1, Math.ceil(characters / 2));
    const estimated_cost_cny = parseFloat(((tokens / 1000) * pricePerKTokenCny).toFixed(4));
    const result: TokenUsageEstimate = { tokens, characters, estimated_cost_cny };
    return result;
  }
}
// FILE: entry/src/main/ets/pages/CreationPage.ets
import promptAction from '@ohos.promptAction';
import { ProjectService, CreationService, type CreateProjectPayload } from '../network/Services';
type StepId =
  | 'inspiration'
  | 'story-core'
  | 'protagonist'
  | 'relationships'
  | 'plot'
  | 'writing';
type StepStatus = 'idle' | 'running' | 'completed' | 'failed';
interface StepTemplate {
  id: StepId;
  title: string;
  desc: string;
}
interface CreationStep extends StepTemplate {
  status: StepStatus;
  preview: string;
}
interface GeneratedTypeLiteralInterface_1 {
  brainstorm_ideas?: Array<string>;
}
interface BrainstormResponse {
  data?: GeneratedTypeLiteralInterface_1;
}
interface GeneratedTypeLiteralInterface_2 {
  leading_brief?: string;
}
interface ProtagonistResponse {
  data?: GeneratedTypeLiteralInterface_2;
}
interface SupportingResponse {
  content?: string;
  data?: Object;
}
interface GeneratedTypeLiteralInterface_3 {
  scene_beats?: Array<string>;
}
interface BeatResponse {
  data?: GeneratedTypeLiteralInterface_3;
}
interface GeneratedTypeLiteralInterface_4 {
  generated_content?: string;
}
interface ScriptResponse {
  data?: GeneratedTypeLiteralInterface_4;
}
const STEP_TEMPLATES: ReadonlyArray<StepTemplate> = [
  { id: 'inspiration', title: '输入灵感', desc: '生成灵感与故事核心' },
  { id: 'story-core', title: '故事核心', desc: '推进故事骨架' },
  { id: 'protagonist', title: '主角人物', desc: '生成主角小传' },
  { id: 'relationships', title: '配角关系', desc: '生成配角' },
  { id: 'plot', title: '情节序列', desc: '生成情节与节拍' },
  { id: 'writing', title: '正文生成', desc: '根据节拍输出正文' }
];
@Entry
@Component
struct CreationPage {
  @State projectId: string = '';
  @State projectName: string = '';
  @State firstIdea: string = '';
  @State storyCore: string = '';
  @State beats: Array<string> = [];
  @State script: string = '';
  @State steps: Array<CreationStep> = STEP_TEMPLATES.map<CreationStep>((step: StepTemplate) => {
    const createdStep: CreationStep = {
      id: step.id,
      title: step.title,
      desc: step.desc,
      status: 'idle',
      preview: ''
    };
    return createdStep;
  });
  build(): void {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          this.renderBinding();
          ForEach(this.steps, (step: CreationStep) => this.renderStep(step), (step: CreationStep) => step.id);
          if (this.script) {
            Column({ space: 8 }) {
              Text('正文输出').fontSize(18).fontWeight(FontWeight.Medium);
              Text(this.script).fontSize(14).fontColor(0x555555);
            }
            .padding(16)
            .backgroundColor(0xffffff)
            .borderRadius(16);
          }
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 });
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderBinding(): void {
    Column({ space: 12 }) {
      TextInput({ placeholder: '项目ID', text: this.projectId })
        .onChange((value: string) => this.projectId = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      TextInput({ placeholder: '项目名称', text: this.projectName })
        .onChange((value: string) => this.projectName = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      TextArea({ placeholder: '创作灵感', text: this.firstIdea })
        .onChange((value: string) => this.firstIdea = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      Row({ space: 12 }) {
        Button('新建/绑定').type(ButtonType.Capsule).backgroundColor(0x8a63ff).onClick(() => this.ensureProject());
        Button('同步项目')
          .type(ButtonType.Capsule)
          .backgroundColor(0xeeeeff)
          .fontColor(0x444444)
          .onClick(() => this.syncProject());
      }
    }
  }
  @Builder
  renderStep(step: CreationStep): void {
    Column({ space: 8 }) {
      Row({ space: 8 }) {
        Column() {
          Text(step.title).fontSize(18).fontWeight(FontWeight.Medium);
          Text(step.desc).fontSize(14).fontColor(0x666666);
        }
        .layoutWeight(1);
        Text(step.status === 'idle' ? '待处理' :
          step.status === 'running' ? '执行中' : step.status === 'completed' ? '已完成' : '失败')
          .fontSize(12)
          .fontColor(step.status === 'failed' ? 0xff6b6b : 0x8a63ff);
      }
      if (step.preview) {
        Text(step.preview).fontSize(14).fontColor(0x555555);
      }
      Button('执行')
        .type(ButtonType.Capsule)
        .backgroundColor(0x8a63ff)
        .onClick(() => this.handleRun(step.id));
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  async ensureProject() {
    if (this.projectId) {
      promptAction.showToast({ message: '已绑定' });
      return;
    }
    const payload: CreateProjectPayload = {
      project_name: this.projectName || 'Harmony 项目',
      first_idea: this.firstIdea
    };
    const created = await ProjectService.create(payload);
    this.projectId = created.project_id ?? created.projectId ?? '';
    promptAction.openToast({ message: '绑定成功' });
  }
  async syncProject() {
    if (!this.projectId) {
      return;
    }
    const data = await ProjectService.detail(this.projectId);
    if (!data) {
      promptAction.openToast({ message: '未找到项目' });
      return;
    }
    this.projectName = data.project_name ?? data.projectName ?? '';
    this.firstIdea = data.first_idea ?? data.firstIdea ?? '';
  }
  setStepStatus(id: StepId, status: StepStatus, preview: string = '') {
    const updated = this.steps.map((step: CreationStep) => {
      if (step.id !== id) {
        return step;
      }
      const nextStep: CreationStep = {
        id: step.id,
        title: step.title,
        desc: step.desc,
        status,
        preview
      };
      return nextStep;
    });
    this.steps = updated;
  }
  async handleRun(kind: StepId) {
    if (!this.projectId) {
      promptAction.openToast({ message: '请先绑定项目' });
      return;
    }
    this.setStepStatus(kind, 'running');
    try {
      switch (kind) {
        case 'inspiration': {
          const idea = this.firstIdea || '请生成一个现代幻想故事';
          const result = await CreationService.brainstorm(this.projectId, idea) as BrainstormResponse;
          let ideas: Array<string> = [];
          if (result && result.data && result.data.brainstorm_ideas) {
            ideas = result.data.brainstorm_ideas;
          }
          if (ideas.length === 0) {
            ideas = [idea];
          }
          this.storyCore = ideas[0];
          await CreationService.advanceStoryCore(this.projectId, this.storyCore);
          this.setStepStatus(kind, 'completed', this.storyCore);
          break;
        }
        case 'story-core': {
          await CreationService.advanceStoryCore(this.projectId, this.storyCore);
          this.setStepStatus(kind, 'completed', this.storyCore);
          break;
        }
        case 'protagonist': {
          const protagonist = await CreationService.generateProtagonist(this.projectId) as ProtagonistResponse;
          let brief = '';
          if (protagonist && protagonist.data && protagonist.data.leading_brief) {
            brief = protagonist.data.leading_brief;
          }
          this.setStepStatus(kind, 'completed', brief);
          break;
        }
        case 'relationships': {
          const supporting = await CreationService.generateSupporting(this.projectId) as SupportingResponse;
          let contentPreview = '';
          if (supporting) {
            if (supporting.content) {
              contentPreview = supporting.content;
            } else if (supporting.data) {
              contentPreview = JSON.stringify(supporting.data);
            }
          }
          const slicedContent = contentPreview.length > 0 ? contentPreview.slice(0, 120) : '';
          this.setStepStatus(kind, 'completed', slicedContent);
          break;
        }
        case 'plot': {
          await CreationService.generatePlot(this.projectId);
          const beatResult = await CreationService.generateBeats(this.projectId) as BeatResponse;
          if (beatResult && beatResult.data && beatResult.data.scene_beats) {
            this.beats = beatResult.data.scene_beats;
          } else {
            this.beats = [];
          }
          this.setStepStatus(kind, 'completed', JSON.stringify(this.beats.slice(0, 2)));
          break;
        }
        case 'writing': {
          const beatsToUse = this.beats.length > 0 ? this.beats : ['Scene 1'];
          const script = await CreationService.generateScripts(this.projectId, beatsToUse) as ScriptResponse;
          if (script && script.data && script.data.generated_content) {
            this.script = script.data.generated_content;
          } else {
            this.script = '';
          }
          this.setStepStatus(kind, 'completed', this.script.slice(0, 120));
          break;
        }
      }
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '执行失败' });
      this.setStepStatus(kind, 'failed', err?.message ?? '');
    }
  }
}
// FILE: entry/src/main/ets/pages/HomePage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ProjectService, ProjectStatus, ProjectListResponse, ProjectSummary } from '../network/Services';
interface StatItem {
  label: string;
  value: string;
}
interface ProjectItem extends ProjectSummary {
  project_id?: string;
  projectId?: string;
  project_name?: string;
  projectName?: string;
  story_core?: string;
}
@Entry
@Component
struct HomePage {
  @State stats: Array<StatItem> = [];
  @State projects: Array<ProjectItem> = [];
  @State loading: boolean = false;
  aboutToAppear(): void {
    this.fetchProjects();
  }
  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          this.renderHeader();
          this.renderStats();
          this.renderActions();
          this.renderProjects();
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 })
        .alignItems(HorizontalAlign.Center);
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderHeader() {
    Column({ space: 8 }) {
      Text('欢迎回来').fontSize(24).fontWeight(FontWeight.Medium);
      Text('准备好继续创作了吗？').fontSize(16).fontColor(0x666666);
      Button('登录 / 注册')
        .type(ButtonType.Capsule)
        .backgroundColor(0xffffff)
        .fontColor(0x8a63ff)
        .border({ color: 0x8a63ff, width: 1, radius: 999 })
        .onClick(() => router.pushUrl({ url: 'pages/LoginPage' }));
    }
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderStats() {
    if (this.stats.length === 0) {
    }
    Row({ space: 12 }) {
      ForEach(this.stats, (item: StatItem) => {
        Column() {
          Text(item.label).fontSize(14).fontColor(0x999999);
          Text(item.value).fontSize(22).fontWeight(FontWeight.Bold);
        }
        .padding(16)
        .backgroundColor(0xf7f2ff)
        .borderRadius(16)
        .layoutWeight(1);
      }, (item: StatItem, index: number) => `${item.label}-${index}`);
    }
  }
  @Builder
  renderActions() {
    Column({ space: 12 }) {
      Button('生成灵感')
        .type(ButtonType.Capsule)
        .backgroundColor(0x8a63ff)
        .onClick(() => router.pushUrl({ url: 'pages/CreationPage' }));
      Button('前往项目列表')
        .type(ButtonType.Capsule)
        .backgroundColor(0xff6ed1)
        .onClick(() => router.pushUrl({ url: 'pages/ProjectsPage' }));
      Button('多线叙事 / 记忆罗盘')
        .type(ButtonType.Capsule)
        .backgroundColor(0x12b886)
        .onClick(() => router.pushUrl({ url: 'pages/NarrativePage' }));
      Button('支付与会员中心')
        .type(ButtonType.Capsule)
        .backgroundColor(0xffd166)
        .fontColor(0x333333)
        .onClick(() => router.pushUrl({ url: 'pages/PaymentPage' }));
    }
  }
  @Builder
  renderProjects() {
    Column({ space: 12 }) {
      Text('最新项目').fontSize(18).fontWeight(FontWeight.Medium);
      ForEach(this.projects, (project: ProjectItem) => {
        Column({ space: 6 }) {
          Text(project.project_name ?? project.projectName ?? '未命名项目')
            .fontSize(16)
            .fontWeight(FontWeight.Bold);
          Text(project.story_core ?? '尚未生成故事核心')
            .fontSize(14)
            .fontColor(0x666666);
        }
        .padding(16)
        .backgroundColor(0xffffff)
        .borderRadius(16)
        .shadow({ radius: 4, color: 0x11000000 });
      }, (project: ProjectItem, index: number) => project.project_id ?? project.projectId ?? `${index}`);
    }
  }
  async fetchProjects(): Promise<void> {
    if (this.loading) {
      return;
    }
    this.loading = true;
    try {
      const response: ProjectListResponse = await ProjectService.list({ limit: 4 });
      const list: Array<ProjectItem> = response.projects ?? [];
      this.projects = list;
      const total = response.total ?? list.length;
      const active = list.filter((item: ProjectItem) => item.status === 'in_progress' || item.status === 'active').length;
      const completed = list.filter((item: ProjectItem) => item.status === 'completed').length;
      this.stats = [
        { label: '项目', value: `${total}` },
        { label: '进行中', value: `${active}` },
        { label: '已完成', value: `${completed}` }
      ];
    } catch (err) {
      const message = (err as Error)?.message ?? '加载失败';
      promptAction.openToast({ message });
    } finally {
      this.loading = false;
    }
  }
}
// FILE: entry/src/main/ets/pages/LoginPage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { AuthService } from '../network/Services';
interface AuthModeToggleConfig {
  textOn: string;
  textOff: string;
  isOn: boolean;
  type: ToggleType;
}
@Entry
@Component
struct LoginPage {
  @State username: string = 'user001';
  @State password: string = 'abcd123456';
  @State email: string = 'user001@example.com';
  @State nickname: string = '';
  @State isRegisterMode: boolean = false;
  @State loading: boolean = false;
  @State error: string = '';
  private buildToggleConfig(): AuthModeToggleConfig {
    return {
      textOn: '注册',
      textOff: '登录',
      isOn: this.isRegisterMode,
      type: ToggleType.Switch
    };
  }
  build() {
    // 登录/注册表单，使用状态切换注册模式
    Column() {
      Column({ space: 20 }) {
        Text('AI 创作助手')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
        Toggle(this.buildToggleConfig())
          .onChange((value: boolean) => this.isRegisterMode = value)
        TextInput({ placeholder: '用户名', text: this.username })
          .onChange((value) => this.username = value)
          .border({ color: 0xdddddd, width: 1, radius: 12 })
          .padding(12)
          .width('100%')
        if (this.isRegisterMode) {
          TextInput({ placeholder: '邮箱', text: this.email })
            .onChange((value) => this.email = value)
            .border({ color: 0xdddddd, width: 1, radius: 12 })
            .padding(12)
            .width('100%')
          TextInput({ placeholder: '昵称(可选)', text: this.nickname })
            .onChange((value) => this.nickname = value)
            .border({ color: 0xdddddd, width: 1, radius: 12 })
            .padding(12)
            .width('100%')
        }
        TextInput({ placeholder: '密码', text: this.password })
          .type(InputType.Password)
          .onChange((value) => this.password = value)
          .border({ color: 0xdddddd, width: 1, radius: 12 })
          .padding(12)
          .width('100%')
        Button(this.loading ? '处理中...' : (this.isRegisterMode ? '注册并登录' : '登录'))
          .type(ButtonType.Capsule)
          .width('100%')
          .backgroundColor(0x8a63ff)
          .onClick(() => {
            if (this.isRegisterMode) {
              this.handleRegister();
            } else {
              this.handleLogin();
            }
          })
          .enabled(!this.loading)
        if (this.error) {
          Text(this.error).fontColor(0xff4d4f).width('100%')
        }
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 48, bottom: 48 })
      .backgroundColor(0xffffff)
      .borderRadius(24)
      .shadow({ radius: 6, color: 0x11000000 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
  async handleLogin() {
    if (!this.username || !this.password) {
      this.error = '请输入账号和密码';
      return;
    }
    this.loading = true;
    this.error = '';
    try {
      // 登录成功后存储 token 并跳转首页
      await AuthService.login({ username: this.username, password: this.password });
      promptAction.showToast({ message: '登录成功' });
      router.replaceUrl({ url: 'pages/HomePage' });
    } catch (err) {
      this.error = err?.message ?? '登录失败';
    } finally {
      this.loading = false;
    }
  }
  async handleRegister() {
    if (!this.username || !this.password || !this.email) {
      this.error = '请填写完整信息';
      return;
    }
    this.loading = true;
    this.error = '';
    try {
      await AuthService.register({
        username: this.username,
        password: this.password,
        email: this.email,
        nickname: this.nickname
      });
      promptAction.showToast({ message: '注册成功' });
      await this.handleLogin();
    } catch (err) {
      this.error = err?.message ?? '注册失败';
    } finally {
      this.loading = false;
    }
  }
}
// FILE: entry/src/main/ets/pages/NarrativePage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { NarrativeService, TokenEstimator, type NarrativeLine, type NarrativeCompass, type TokenUsageEstimate } from '../network/Services';
import MemoryCompassCard from '../components/MemoryCompassCard';
interface LineForm {
  title: string;
  tone: string;
  goal: string;
}
@Entry
@Component
struct NarrativePage {
  @State projectId: string = '';
  @State lines: Array<NarrativeLine> = [];
  @State activeLineId: string = '';
  @State lineForm: LineForm = { title: '主线 A', tone: '紧凑', goal: '推进主角成长' };
  @State prompt: string = '';
  @State generatedPreview: string = '';
  @State compass: NarrativeCompass = {} as NarrativeCompass;
  @State tokenEstimate: TokenUsageEstimate = { tokens: 0, characters: 0, estimated_cost_cny: 0 };
  @State pricePerK: number = 0.12;
  aboutToAppear(): void {
    if (this.projectId) {
      this.loadLines();
    }
  }
  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          this.renderProjectBinding();
          this.renderLineManager();
          this.renderBeatGenerator();
          this.renderTokenEstimator();
          this.renderCompass();
          Button('返回首页')
            .type(ButtonType.Capsule)
            .backgroundColor(0xeeeeff)
            .fontColor(0x333333)
            .onClick(() => router.pushUrl({ url: 'pages/HomePage' }));
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 });
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderProjectBinding() {
    Column({ space: 12 }) {
      Text('多线叙事控制台').fontSize(22).fontWeight(FontWeight.Bold);
      TextInput({ placeholder: '项目ID', text: this.projectId })
        .onChange((value: string) => this.projectId = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      Row({ space: 12 }) {
        Button('同步线路')
          .type(ButtonType.Capsule)
          .backgroundColor(0x8a63ff)
          .onClick(() => this.loadLines());
        Button('刷新记忆罗盘')
          .type(ButtonType.Capsule)
          .backgroundColor(0x12b886)
          .onClick(() => this.loadCompass());
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderLineManager() {
    Column({ space: 12 }) {
      Text('线路管理').fontSize(18).fontWeight(FontWeight.Medium);
      Row({ space: 12 }) {
        TextInput({ placeholder: '路线标题', text: this.lineForm.title })
          .onChange((value: string) => this.lineForm = { ...this.lineForm, title: value })
          .border({ color: 0xdddddd, width: 1, radius: 12 })
          .padding(12)
          .layoutWeight(1);
        TextInput({ placeholder: '调性/风格', text: this.lineForm.tone })
          .onChange((value: string) => this.lineForm = { ...this.lineForm, tone: value })
          .border({ color: 0xdddddd, width: 1, radius: 12 })
          .padding(12)
          .layoutWeight(1);
      }
      TextInput({ placeholder: '剧情目标', text: this.lineForm.goal })
        .onChange((value: string) => this.lineForm = { ...this.lineForm, goal: value })
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      Button('新增故事线')
        .type(ButtonType.Capsule)
        .backgroundColor(0xff6ed1)
        .onClick(() => this.createLine());
      Column({ space: 8 }) {
        ForEach(this.lines, (line: NarrativeLine) => this.renderLineRow(line), (line: NarrativeLine, index: number) => `${line.line_id}-${index}`);
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderLineRow(line: NarrativeLine) {
    Column({ space: 6 }) {
      Row() {
        Column() {
          Text(line.title ?? '未命名故事线').fontSize(16).fontWeight(FontWeight.Bold);
          Text(`${line.tone ?? '风格未定'} · ${line.goal ?? '目标未定'}`).fontSize(12).fontColor(0x666666);
          Text(`进度：${line.progress ?? '未开始'}`).fontSize(12).fontColor(0x8a63ff);
        }
        .layoutWeight(1);
        Button(this.activeLineId === line.line_id ? '当前线路' : '设为当前')
          .type(ButtonType.Capsule)
          .backgroundColor(this.activeLineId === line.line_id ? 0x12b886 : 0xeeeeff)
          .fontColor(this.activeLineId === line.line_id ? 0xffffff : 0x333333)
          .onClick(() => this.activeLineId = line.line_id);
      }
      if (line.last_checkpoint) {
        Text(`最近片段：${line.last_checkpoint}`).fontSize(12).fontColor(0x444444);
      }
      Row({ space: 12 }) {
        Text(`消耗: ${line.tokens_used ?? 0} tokens`).fontSize(12).fontColor(0x999999);
        Button('合并至当前')
          .type(ButtonType.Normal)
          .backgroundColor(0xffffff)
          .border({ color: 0x8a63ff, width: 1, radius: 12 })
          .fontColor(0x8a63ff)
          .onClick(() => this.mergeToActive(line.line_id));
      }
    }
    .padding(12)
    .backgroundColor(0xf7f7f9)
    .borderRadius(12);
  }
  @Builder
  renderBeatGenerator() {
    Column({ space: 12 }) {
      Text('多线推进').fontSize(18).fontWeight(FontWeight.Medium);
      TextArea({ placeholder: '输入剧情提示，自动扩写当前故事线', text: this.prompt })
        .onChange((value: string) => this.updatePrompt(value))
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      Button('生成片段并记录记忆')
        .type(ButtonType.Capsule)
        .backgroundColor(0x8a63ff)
        .onClick(() => this.generateBeat());
      if (this.generatedPreview) {
        Column({ space: 6 }) {
          Text('生成片段预览').fontSize(16).fontWeight(FontWeight.Medium);
          Text(this.generatedPreview).fontSize(14).fontColor(0x444444);
        }
        .padding(12)
        .backgroundColor(0xffffff)
        .borderRadius(12);
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderTokenEstimator() {
    Column({ space: 8 }) {
      Text('本地 Token 估算 (CNY)').fontSize(18).fontWeight(FontWeight.Medium);
      Row({ space: 12 }) {
        Text(`字符数：${this.tokenEstimate.characters}`).fontSize(12).fontColor(0x666666);
        Text(`估算 Tokens：${this.tokenEstimate.tokens}`).fontSize(12).fontColor(0x666666);
        Text(`费用≈¥${this.tokenEstimate.estimated_cost_cny}`).fontSize(12).fontColor(0x12b886);
      }
      Slider({ value: this.pricePerK, min: 0.02, max: 1, step: 0.01 })
        .onChange((value: number) => this.updatePricePerK(value))
        .blockColor(0x8a63ff)
        .trackColor(0xeeeeff);
      Text(`单价 ¥${this.pricePerK.toFixed(2)} / 1000 tokens`).fontSize(12).fontColor(0x8a63ff);
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderCompass() {
    Column({ space: 8 }) {
      Text('记忆罗盘').fontSize(18).fontWeight(FontWeight.Medium);
      MemoryCompassCard({ compass: this.compass });
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  async loadLines(): Promise<void> {
    if (!this.projectId) {
      promptAction.showToast({ message: '请先填写项目ID' });
      return;
    }
    try {
      const data = await NarrativeService.list(this.projectId);
      this.lines = data?.lines ?? [];
      this.activeLineId = data?.active_line_id ?? (this.lines.length > 0 ? this.lines[0].line_id : '');
      this.compass = data?.compass ?? this.compass;
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '加载线路失败' });
    }
  }
  async loadCompass(): Promise<void> {
    if (!this.projectId) {
      promptAction.showToast({ message: '请先填写项目ID' });
      return;
    }
    try {
      this.compass = await NarrativeService.fetchCompass(this.projectId);
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '刷新罗盘失败' });
    }
  }
  async createLine(): Promise<void> {
    if (!this.projectId) {
      promptAction.showToast({ message: '请先填写项目ID' });
      return;
    }
    try {
      const created = await NarrativeService.createLine({ project_id: this.projectId, title: this.lineForm.title, tone: this.lineForm.tone, goal: this.lineForm.goal });
      this.lines = [...this.lines, created];
      this.activeLineId = created.line_id;
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '新增故事线失败' });
    }
  }
  async mergeToActive(sourceLineId: string): Promise<void> {
    if (!this.projectId || !this.activeLineId || sourceLineId === this.activeLineId) {
      return;
    }
    try {
      const result = await NarrativeService.mergeLines({ project_id: this.projectId, target_line_id: this.activeLineId, source_line_id: sourceLineId });
      promptAction.showToast({ message: result?.summary ?? '合并完成' });
      this.loadLines();
      if (result?.compass) {
        this.compass = result.compass;
      }
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '合并失败' });
    }
  }
  updatePrompt(value: string): void {
    this.prompt = value;
    this.runEstimate();
  }
  updatePricePerK(value: number): void {
    this.pricePerK = value;
    this.runEstimate();
  }
  runEstimate(): void {
    this.tokenEstimate = TokenEstimator.estimate([this.prompt, this.generatedPreview], this.pricePerK);
  }
  async generateBeat(): Promise<void> {
    if (!this.projectId || !this.activeLineId) {
      promptAction.showToast({ message: '请先选择故事线' });
      return;
    }
    try {
      const result = await NarrativeService.pushBeat({ project_id: this.projectId, line_id: this.activeLineId, prompt: this.prompt, word_preference: 'multi-thread' });
      this.generatedPreview = result?.content ?? '';
      this.compass = result?.compass ?? this.compass;
      this.runEstimate();
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '生成失败' });
    }
  }
}
// FILE: entry/src/main/ets/pages/PaymentPage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { PaymentsService, PointsService, type PlanItem, type PaymentCredential } from '../network/Services';
interface PointsBalanceLite {
  usable_points?: number;
}
interface PlansResponseLite {
  plans?: Array<PlanItem>;
}
@Entry
@Component
struct PaymentPage {
  @State plans: Array<PlanItem> = [];
  @State selectedPlanId: string = '';
  @State selectedChannel: string = 'alipay_page';
  @State credential: PaymentCredential = {} as PaymentCredential;
  @State pointsBalance: number = 0;
  @State usePoints: boolean = true;
  aboutToAppear(): void {
    this.loadData();
  }
  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          this.renderSummary();
          this.renderPlans();
          this.renderChannels();
          this.renderCredential();
          Button('返回首页')
            .type(ButtonType.Capsule)
            .backgroundColor(0xeeeeff)
            .fontColor(0x333333)
            .onClick(() => router.pushUrl({ url: 'pages/HomePage' }));
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 });
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderSummary() {
    Column({ space: 8 }) {
      Text('支付与会员积分').fontSize(22).fontWeight(FontWeight.Bold);
      Text(`可用积分：${this.pointsBalance} 分`).fontSize(14).fontColor(0x12b886);
      Row({ space: 10 }) {
        Toggle({ isOn: this.usePoints, textOn: '使用积分抵扣', textOff: '不使用', type: ToggleType.Switch })
          .onChange((value: boolean) => this.usePoints = value);
        Text(this.usePoints ? '开启' : '关闭').fontSize(12).fontColor(0x666666);
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderPlans() {
    Column({ space: 10 }) {
      Text('选择会员套餐 (CNY)').fontSize(18).fontWeight(FontWeight.Medium);
      ForEach(this.plans, (plan: PlanItem, index: number) => {
        Column({ space: 6 }) {
          Row() {
            Column() {
              Text(plan.name ?? '未命名套餐').fontSize(16).fontWeight(FontWeight.Bold);
              Text(plan.description ?? '持续创作流量包').fontSize(12).fontColor(0x666666);
            }
            .layoutWeight(1);
            Text(`¥${this.getPlanPrice(plan).toFixed(2)}`).fontSize(16).fontWeight(FontWeight.Bold).fontColor(0x8a63ff);
          }
          Row({ space: 8 }) {
            Text(this.usePoints ? '积分抵扣已启用' : '不使用积分').fontSize(12).fontColor(0x999999);
            Text(`应付≈¥${this.calcPayable(plan).toFixed(2)}`).fontSize(12).fontColor(0x12b886);
          }
          Button(this.selectedPlanId === plan.plan_id ? '已选择' : '选择')
            .type(ButtonType.Capsule)
            .backgroundColor(this.selectedPlanId === plan.plan_id ? 0x12b886 : 0x8a63ff)
            .onClick(() => this.selectedPlanId = plan.plan_id);
        }
        .padding(14)
        .backgroundColor(0xffffff)
        .borderRadius(14);
      }, (plan: PlanItem, index: number) => plan.plan_id ?? `plan-${index}`);
      Button('创建支付订单')
        .type(ButtonType.Capsule)
        .backgroundColor(0xff6ed1)
        .onClick(() => this.createOrder());
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderChannels() {
    Column({ space: 10 }) {
      Text('支付渠道').fontSize(18).fontWeight(FontWeight.Medium);
      Row({ space: 12 }) {
        Button(this.selectedChannel === 'alipay_page' ? '支付宝' : '切换到支付宝')
          .type(ButtonType.Capsule)
          .backgroundColor(this.selectedChannel === 'alipay_page' ? 0x12b886 : 0xeeeeff)
          .fontColor(this.selectedChannel === 'alipay_page' ? 0xffffff : 0x333333)
          .onClick(() => this.selectedChannel = 'alipay_page');
        Button(this.selectedChannel === 'wechat_native' ? '微信扫码' : '切换到微信')
          .type(ButtonType.Capsule)
          .backgroundColor(this.selectedChannel === 'wechat_native' ? 0x12b886 : 0xeeeeff)
          .fontColor(this.selectedChannel === 'wechat_native' ? 0xffffff : 0x333333)
          .onClick(() => this.selectedChannel = 'wechat_native');
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  @Builder
  renderCredential() {
    Column({ space: 8 }) {
      Text('支付凭证/跳转信息').fontSize(18).fontWeight(FontWeight.Medium);
      if (this.credential?.alipay_page) {
        Text(`支付宝收款页：${this.credential.alipay_page.page_url ?? '-'}`).fontSize(12).fontColor(0x8a63ff);
      }
      if (this.credential?.wechat_native) {
        Text(`微信扫码：${this.credential.wechat_native.code_url ?? '-'}`).fontSize(12).fontColor(0x12b886);
      }
      if (!this.credential?.alipay_page && !this.credential?.wechat_native) {
        Text('创建订单后将展示跳转链接或二维码地址').fontSize(12).fontColor(0x999999);
      }
    }
    .padding(16)
    .backgroundColor(0xffffff)
    .borderRadius(16);
  }
  async loadData(): Promise<void> {
    try {
      const plansResp: PlansResponseLite = await PaymentsService.listPlans() as PlansResponseLite;
      this.plans = plansResp?.plans ?? [];
      this.selectedPlanId = this.plans.length > 0 ? this.plans[0].plan_id : '';
      const points = await PointsService.balance() as PointsBalanceLite;
      this.pointsBalance = points?.usable_points ?? 0;
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '加载失败' });
    }
  }
  async createOrder(): Promise<void> {
    if (!this.selectedPlanId) {
      promptAction.showToast({ message: '请先选择套餐' });
      return;
    }
    try {
      const result = await PaymentsService.createOrder(this.selectedPlanId, this.selectedChannel) as { credential?: PaymentCredential };
      this.credential = result?.credential ?? {} as PaymentCredential;
      promptAction.showToast({ message: '订单已生成，请按照提示支付' });
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '下单失败' });
    }
  }
  getPlanPrice(plan: PlanItem): number {
    const raw = plan?.price?.amount_formatted ?? '0';
    const numeric = parseFloat(raw.replace(/[^0-9.]/g, ''));
    if (Number.isNaN(numeric)) {
      return 0;
    }
    return numeric;
  }
  calcPayable(plan: PlanItem): number {
    const price = this.getPlanPrice(plan);
    const deduction = this.usePoints ? Math.min(this.pointsBalance, price) : 0;
    return Math.max(0, price - deduction);
  }
}
// FILE: entry/src/main/ets/pages/ProfilePage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { AuthService, PointsService, PaymentsService } from '../network/Services';
import { apiClient } from '../network/ApiClient';
interface PointsBalance {
  usable_points?: number;
  level_name?: string;
}
interface TransactionItem {
  reason?: string;
  status?: string;
  amount?: number;
}
interface PlanPrice {
  amount_formatted?: string;
}
interface PlanItem {
  plan_id: string;
  name?: string;
  price?: PlanPrice;
  description?: string;
}
interface CredentialDetail {
  page_url?: string;
  code_url?: string;
}
interface PaymentCredential {
  alipay_page?: CredentialDetail;
  wechat_native?: CredentialDetail;
}
interface TransactionsResponse {
  transactions?: Array<TransactionItem>;
}
interface PlansResponse {
  plans?: Array<PlanItem>;
}
interface OrderResponse {
  credential?: PaymentCredential;
}
@Entry
@Component
struct ProfilePage {
  @State userName: string = '未登录';
  @State userEmail: string = '';
  @State points?: PointsBalance = undefined;
  @State transactions: Array<TransactionItem> = [];
  @State plans: Array<PlanItem> = [];
  @State selectedChannel: string = 'alipay_page';
  @State credential: PaymentCredential = {} as PaymentCredential;
  aboutToAppear(): void {
    this.fetchProfile();
    this.refreshCenter();
  }
  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          this.renderAccount();
          this.renderTransactions();
          this.renderRecharge();
          Button('退出登录')
            .type(ButtonType.Capsule)
            .backgroundColor(0xff6b6b)
            .onClick(() => this.logout());
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 });
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderAccount() {
    Column({ space: 8 }) {
      Text(this.userName).fontSize(24).fontWeight(FontWeight.Bold);
      Text(this.userEmail).fontSize(14).fontColor(0x666666);
      if (this.points) {
        Text(`可用积分：${this.points.usable_points ?? 0}`).fontSize(16);
        Text(`等级：${this.points.level_name ?? '-'}`).fontSize(14).fontColor(0x999999);
      }
      Button('刷新')
        .type(ButtonType.Capsule)
        .backgroundColor(0xeeeeff)
        .fontColor(0x333333)
        .onClick(() => this.refreshCenter());
    }
    .padding(24)
    .backgroundColor(0xffffff)
    .borderRadius(20);
  }
  @Builder
  renderTransactions() {
    Column({ space: 8 }) {
      Text('积分流水').fontSize(20).fontWeight(FontWeight.Medium);
      if (this.transactions.length === 0) {
        Text('暂无记录').fontColor(0x999999);
      } else {
        ForEach(this.transactions.slice(0, 5), (item: TransactionItem, index: number) => this.renderTransactionRow(item), (_item: TransactionItem, index: number) => `tx-${index}`);
      }
    }
    .padding(24)
    .backgroundColor(0xffffff)
    .borderRadius(20);
  }
  @Builder
  renderTransactionRow(item: TransactionItem) {
    Row() {
      Text(`${item.reason ?? ''} · ${item.status ?? ''}`);
      Blank();
      Text(`${(item.amount ?? 0) > 0 ? '+' : ''}${item.amount ?? 0}`)
        .fontColor((item.amount ?? 0) >= 0 ? 0x12b886 : 0xff6b6b);
    }
  }
  @Builder
  renderRecharge() {
    Column({ space: 12 }) {
      Text('充值 / 会员').fontSize(20).fontWeight(FontWeight.Medium);
      Row({ space: 12 }) {
        Button(this.selectedChannel === 'alipay_page' ? '支付宝' : '微信扫码')
          .type(ButtonType.Capsule)
          .backgroundColor(0x8a63ff)
          .onClick(() => {
            this.selectedChannel = this.selectedChannel === 'alipay_page' ? 'wechat_native' : 'alipay_page';
          });
      }
      ForEach(this.plans, (plan: PlanItem, index: number) => {
        Column({ space: 4 }) {
          Text(`${plan.name ?? ''} · ${plan.price?.amount_formatted ?? ''}`).fontSize(18).fontWeight(FontWeight.Bold);
          Text(plan.description ?? '').fontSize(14).fontColor(0x666666);
          Button('立即购买')
            .type(ButtonType.Capsule)
            .backgroundColor(0x8a63ff)
            .onClick(() => this.createOrder(plan.plan_id));
        }
        .padding(16)
        .backgroundColor(0xffffff)
        .borderRadius(16);
      }, (plan: PlanItem, index: number) => plan.plan_id ?? `plan-${index}`);
      if (this.credential?.alipay_page) {
        Text(`支付宝链接：${this.credential.alipay_page.page_url}`)
          .fontSize(12)
          .fontColor(0x8a63ff);
      }
      if (this.credential?.wechat_native) {
        Text(`微信扫码链接：${this.credential.wechat_native.code_url}`)
          .fontSize(12)
          .fontColor(0x12b886);
      }
    }
    .padding(24)
    .backgroundColor(0xffffff)
    .borderRadius(20);
  }
  async fetchProfile(): Promise<void> {
    try {
      const profile = await AuthService.profile() as Record<string, Object>;
      this.userName = (profile?.name ?? profile?.username ?? '未登录') as string;
      this.userEmail = (profile?.email ?? '') as string;
    } catch (_) {}
  }
  async refreshCenter(): Promise<void> {
    try {
      this.points = await PointsService.balance() as PointsBalance;
      const tx: TransactionsResponse = await PointsService.transactions() as TransactionsResponse;
      this.transactions = tx?.transactions ?? [];
      const plansResp: PlansResponse = await PaymentsService.listPlans() as PlansResponse;
      this.plans = plansResp?.plans ?? [];
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '加载失败' });
    }
  }
  async createOrder(planId: string): Promise<void> {
    try {
      const result: OrderResponse = await PaymentsService.createOrder(planId, this.selectedChannel) as OrderResponse;
      this.credential = result?.credential ?? {};
      promptAction.showToast({ message: '订单创建成功' });
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '下单失败' });
    }
  }
  logout(): void {
    apiClient.setToken('');
    router.replaceUrl({ url: 'pages/LoginPage' });
  }
}
// FILE: entry/src/main/ets/pages/ProjectsPage.ets
import promptAction from '@ohos.promptAction';
import { ProjectService, type CreateProjectPayload, type ProjectSummary } from '../network/Services';
interface ProjectItem extends ProjectSummary {
  is_favorite?: boolean;
}
interface ProjectFilterOption {
  label: string;
  value: string;
}
const PROJECT_FILTER_OPTIONS: Array<ProjectFilterOption> = [
  { label: '全部', value: '' },
  { label: '创作中', value: 'in_progress' },
  { label: '完成', value: 'completed' },
  { label: '归档', value: 'archived' }
];
interface FavoriteTogglePayload {
  is_favorite: boolean;
}
@Entry
@Component
struct ProjectsPage {
  @State projects: Array<ProjectItem> = [];
  @State search: string = '';
  @State status: string = '';
  @State newName: string = '';
  @State newIdea: string = '';
  aboutToAppear(): void {
    this.fetchProjects();
  }
  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          TextInput({ placeholder: '搜索项目', text: this.search })
            .onChange((value: string) => {
              this.search = value;
              this.fetchProjects();
            })
            .border({ color: 0xdddddd, width: 1, radius: 12 })
            .padding(12)
            .width('100%');
          this.renderFilters();
          this.renderCreator();
          this.renderList();
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 32, bottom: 32 });
      }
      .width('100%')
      .layoutWeight(1);
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xf7f7f9)
    .alignItems(HorizontalAlign.Center);
  }
  @Builder
  renderFilters() {
    Row({ space: 12 }) {
      ForEach(PROJECT_FILTER_OPTIONS, (item: ProjectFilterOption) => {
        Text(item.label)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.status === item.value ? 0x8a63ff : 0xf2f2f2)
          .fontColor(this.status === item.value ? 0xffffff : 0x333333)
          .borderRadius(999)
          .onClick(() => {
            this.status = item.value;
            this.fetchProjects();
          });
      }, (item: ProjectFilterOption, index: number) => `${item.value}-${index}`);
    }
  }
  @Builder
  renderCreator() {
    Column({ space: 12 }) {
      TextInput({ placeholder: '项目名称', text: this.newName })
        .onChange((value: string) => this.newName = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      TextArea({ placeholder: '创作灵感', text: this.newIdea })
        .onChange((value: string) => this.newIdea = value)
        .border({ color: 0xdddddd, width: 1, radius: 12 })
        .padding(12)
        .width('100%');
      Button('创建项目')
        .type(ButtonType.Capsule)
        .backgroundColor(0x8a63ff)
        .enabled(!!this.newName)
        .onClick(() => this.createProject());
    }
  }
  @Builder
  renderList() {
    Column({ space: 12 }) {
      ForEach(this.projects, (project: ProjectItem, index: number) => {
        Column({ space: 6 }) {
          Row() {
            Column() {
              Text(project.project_name).fontSize(18).fontWeight(FontWeight.Bold);
              Text(project.status).fontSize(12).fontColor(0x8a63ff);
            }
            .layoutWeight(1);
            Button(project.is_favorite ? '取消收藏' : '收藏')
              .type(ButtonType.Normal)
              .fontColor(0x8a63ff)
              .backgroundColor(0xeeeeff)
              .onClick(() => this.toggleFavorite(project));
          }
          Text(project.story_core ?? '尚无故事核心').fontSize(14);
          Row({ space: 12 }) {
            Button('删除')
              .type(ButtonType.Normal)
              .fontColor(0xffffff)
              .backgroundColor(0xff6b6b)
              .onClick(() => this.deleteProject(project));
          }
        }
        .padding(16)
        .backgroundColor(0xffffff)
        .borderRadius(16);
      }, (project: ProjectItem, index: number) => project.project_id ?? project.projectId ?? `${index}`);
    }
  }
  async fetchProjects(): Promise<void> {
    const data = await ProjectService.list({ search: this.search, status: this.status });
    this.projects = data?.projects ?? [];
  }
  async createProject(): Promise<void> {
    try {
      const payload: CreateProjectPayload = { project_name: this.newName, first_idea: this.newIdea };
      await ProjectService.create(payload);
      promptAction.showToast({ message: '创建成功' });
      this.newName = '';
      this.newIdea = '';
      await this.fetchProjects();
    } catch (err) {
      promptAction.showToast({ message: err?.message ?? '创建失败' });
    }
  }
  async toggleFavorite(project: ProjectItem): Promise<void> {
    const payload: FavoriteTogglePayload = { is_favorite: !(project.is_favorite ?? false) };
    await ProjectService.update(project.project_id ?? project.projectId ?? '', payload);
    await this.fetchProjects();
  }
  async deleteProject(project: ProjectItem): Promise<void> {
    await ProjectService.remove(project.project_id ?? project.projectId ?? '');
    await this.fetchProjects();
  }
}
// FILE: entry/src/main/module.json5
{
  "module": {
    "name": "entry",
    "type": "entry",
    "description": "$string:module_desc",
    "mainElement": "EntryAbility",
    "deviceTypes": [
      "phone"
    ],
    "deliveryWithInstall": true,
    "installationFree": false,
    "pages": "$profile:main_pages",
    "abilities": [
      {
        "name": "EntryAbility",
        "srcEntry": "./ets/entryability/EntryAbility.ets",
        "description": "$string:EntryAbility_desc",
        "icon": "$media:layered_image",
        "label": "$string:EntryAbility_label",
        "startWindowIcon": "$media:startIcon",
        "startWindowBackground": "$color:start_window_background",
        "exported": true,
        "skills": [
          {
            "entities": [
              "entity.system.home"
            ],
            "actions": [
              "ohos.want.action.home"
            ]
          }
        ]
      }
    ],
    "requestPermissions": [
      {
        "name": "ohos.permission.INTERNET",
        "usedScene": { "ability": [ "EntryAbility" ], "when": "inuse" }
      },
      {
        "name": "ohos.permission.GET_NETWORK_INFO",
        "usedScene": { "ability": [ "EntryAbility" ], "when": "inuse" }
      }
    ],
    "extensionAbilities": [
      {
        "name": "EntryBackupAbility",
        "srcEntry": "./ets/entrybackupability/EntryBackupAbility.ets",
        "type": "backup",
        "exported": false,
        "metadata": [
          {
            "name": "ohos.extension.backup",
            "resource": "$profile:backup_config"
          }
        ],
      }
    ]
  }
}
// FILE: entry/src/main/resources/base/element/color.json
{
  "color": [
    {
      "name": "start_window_background",
      "value": "#FFFFFF"
    },
    {
      "name": "start_window_bg",
      "value": "#FFFFFF"
    }
  ]
}
// FILE: entry/src/main/resources/base/element/float.json
{
  "float": [
    {
      "name": "page_text_font_size",
      "value": "50fp"
    }
  ]
}
// FILE: entry/src/main/resources/base/element/string.json
{
  "string": [
    {
      "name": "module_desc",
      "value": "module description"
    },
    {
      "name": "EntryAbility_desc",
      "value": "description"
    },
    {
      "name": "EntryAbility_label",
      "value": "label"
    }
  ]
}// FILE: entry/src/main/resources/base/media/layered_image.json
{
  "layered-image":
  {
    "background" : "$media:background",
    "foreground" : "$media:foreground"
  }
}// FILE: entry/src/main/resources/base/profile/backup_config.json
{
  "allowToBackupRestore": true
}// FILE: entry/src/main/resources/base/profile/main_pages.json
{
  "src": [
    "pages/HomePage",
    "pages/LoginPage",
    "pages/CreationPage",
    "pages/ProjectsPage",
    "pages/ProfilePage",
    "pages/NarrativePage",
    "pages/PaymentPage"
  ]
}
// FILE: entry/src/main/resources/dark/element/color.json
{
  "color": [
    {
      "name": "start_window_background",
      "value": "#000000"
    }
  ]
}// FILE: entry/src/mock/mock-config.json5
{
}// FILE: entry/src/ohosTest/ets/test/Ability.test.ets
import { hilog } from '@kit.PerformanceAnalysisKit';
import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
export default function abilityTest() {
  describe('ActsAbilityTest', () => {
    // Defines a test suite. Two parameters are supported: test suite name and test suite function.
    beforeAll(() => {
      // Presets an action, which is performed only once before all test cases of the test suite start.
      // This API supports only one parameter: preset action function.
    })
    beforeEach(() => {
      // Presets an action, which is performed before each unit test case starts.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: preset action function.
    })
    afterEach(() => {
      // Presets a clear action, which is performed after each unit test case ends.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: clear action function.
    })
    afterAll(() => {
      // Presets a clear action, which is performed after all test cases of the test suite end.
      // This API supports only one parameter: clear action function.
    })
    it('assertContain', 0, () => {
      // Defines a test case. This API supports three parameters: test case name, filter parameter, and test case function.
      hilog.info(0x0000, 'testTag', '%{public}s', 'it begin');
      let a = 'abc';
      let b = 'b';
      // Defines a variety of assertion methods, which are used to declare expected boolean conditions.
      expect(a).assertContain(b);
      expect(a).assertEqual(a);
    })
  })
}// FILE: entry/src/ohosTest/ets/test/List.test.ets
import abilityTest from './Ability.test';
export default function testsuite() {
  abilityTest();
}// FILE: entry/src/ohosTest/module.json5
{
  "module": {
    "name": "entry_test",
    "type": "feature",
    "deviceTypes": [
      "phone"
    ],
    "deliveryWithInstall": true,
    "installationFree": false
  }
}
// FILE: entry/src/test/List.test.ets
import localUnitTest from './LocalUnit.test';
export default function testsuite() {
  localUnitTest();
}// FILE: entry/src/test/LocalUnit.test.ets
import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
export default function localUnitTest() {
  describe('localUnitTest', () => {
    // Defines a test suite. Two parameters are supported: test suite name and test suite function.
    beforeAll(() => {
      // Presets an action, which is performed only once before all test cases of the test suite start.
      // This API supports only one parameter: preset action function.
    });
    beforeEach(() => {
      // Presets an action, which is performed before each unit test case starts.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: preset action function.
    });
    afterEach(() => {
      // Presets a clear action, which is performed after each unit test case ends.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: clear action function.
    });
    afterAll(() => {
      // Presets a clear action, which is performed after all test cases of the test suite end.
      // This API supports only one parameter: clear action function.
    });
    it('assertContain', 0, () => {
      // Defines a test case. This API supports three parameters: test case name, filter parameter, and test case function.
      let a = 'abc';
      let b = 'b';
      // Defines a variety of assertion methods, which are used to declare expected boolean conditions.
      expect(a).assertContain(b);
      expect(a).assertEqual(a);
    });
  });
}