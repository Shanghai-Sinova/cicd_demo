@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem
@rem SPDX-License-Identifier: Apache-2.0
@rem
@if "%DEBUG%"=="" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################
@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal
set DIRNAME=%~dp0
if "%DIRNAME%"=="" set DIRNAME=.
@rem This is normally unused
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%
@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi
@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"
@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome
set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if %ERRORLEVEL% equ 0 goto execute
echo. 1>&2
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH. 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2
goto fail
:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe
if exist "%JAVA_EXE%" goto execute
echo. 1>&2
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME% 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2
goto fail
:execute
@rem Setup the command line
set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*
:end
@rem End local scope for the variables with windows NT shell
if %ERRORLEVEL% equ 0 goto mainEnd
:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
set EXIT_CODE=%ERRORLEVEL%
if %EXIT_CODE% equ 0 set EXIT_CODE=1
if not ""=="%GRADLE_EXIT_CONSOLE%" exit %EXIT_CODE%
exit /b %EXIT_CODE%
:mainEnd
if "%OS%"=="Windows_NT" endlocal
:omega
org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
android.useAndroidX=true
android.enableJetifier=true
kotlin.code.style=official
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "NovelCreationMobile"
include(":app")
import org.jetbrains.kotlin.gradle.tasks.KotlinCompile
plugins {
    id("com.android.application") version "8.13.1" apply false
    id("org.jetbrains.kotlin.android") version "2.0.0" apply false
    id("org.jetbrains.kotlin.plugin.serialization") version "2.0.0" apply false
    id("org.jetbrains.kotlin.plugin.compose") version "2.0.0" apply false
}
tasks.withType<KotlinCompile>().configureEach {
    kotlinOptions.jvmTarget = "17"
}
#!/bin/sh
#
# Copyright © 2015-2021 the original authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#
##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
#   Important for running:
#
#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
#       noncompliant, but you have some other compliant shell such as ksh or
#       bash, then to run this script, type that shell name before the whole
#       command line, like:
#
#           ksh Gradle
#
#       Busybox and similar reduced shells will NOT work, because this script
#       requires all of these POSIX shell features:
#         * functions;
#         * expansions «$var», «${var}», «${var:-default}», «${var+SET}»,
#           «${var#prefix}», «${var%suffix}», and «$( cmd )»;
#         * compound commands having a testable exit status, especially «case»;
#         * various built-in commands including «command», «set», and «ulimit».
#
#   Important for patching:
#
#   (2) This script targets any POSIX shell, so it avoids extensions provided
#       by Bash, Ksh, etc; in particular arrays are avoided.
#
#       The "traditional" practice of packing multiple parameters into a
#       space-separated string is a well documented source of bugs and security
#       problems, so this is (mostly) avoided, by progressively accumulating
#       options in "$@", and eventually passing that to Java.
#
#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
#       see the in-line comments for details.
#
#       There are tweaks for specific operating systems such as AIX, CygWin,
#       Darwin, MinGW, and NonStop.
#
#   (3) This script is generated from the Groovy template
#       https://github.com/gradle/gradle/blob/HEAD/platforms/jvm/plugins-application/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
#       within the Gradle project.
#
#       You can find Gradle at https://github.com/gradle/gradle/.
#
##############################################################################
# Attempt to set APP_HOME
# Resolve links: $0 may be a link
app_path=$0
# Need this for daisy-chained symlinks.
while
    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
    [ -h "$app_path" ]
do
    ls=$( ls -ld "$app_path" )
    link=${ls#*' -> '}
    case $link in             #(
      /*)   app_path=$link ;; #(
      *)    app_path=$APP_HOME$link ;;
    esac
done
# This is normally unused
# shellcheck disable=SC2034
APP_BASE_NAME=${0##*/}
# Discard cd standard output in case $CDPATH is set (https://github.com/gradle/gradle/issues/25036)
APP_HOME=$( cd -P "${APP_HOME:-./}" > /dev/null && printf '%s\n' "$PWD" ) || exit
# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum
warn () {
    echo "$*"
} >&2
die () {
    echo
    echo "$*"
    echo
    exit 1
} >&2
# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "$( uname )" in                #(
  CYGWIN* )         cygwin=true  ;; #(
  Darwin* )         darwin=true  ;; #(
  MSYS* | MINGW* )  msys=true    ;; #(
  NONSTOP* )        nonstop=true ;;
esac
CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD=$JAVA_HOME/jre/sh/java
    else
        JAVACMD=$JAVA_HOME/bin/java
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD=java
    if ! command -v java >/dev/null 2>&1
    then
        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
fi
# Increase the maximum file descriptors if we can.
if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
    case $MAX_FD in #(
      max*)
        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        MAX_FD=$( ulimit -H -n ) ||
            warn "Could not query maximum file descriptor limit"
    esac
    case $MAX_FD in  #(
      '' | soft) :;; #(
      *)
        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        ulimit -n "$MAX_FD" ||
            warn "Could not set maximum file descriptor limit to $MAX_FD"
    esac
fi
# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * -D...appname settings
#   * --module-path (only if needed)
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.
# For Cygwin or MSYS, switch paths to Windows format before running java
if "$cygwin" || "$msys" ; then
    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )
    JAVACMD=$( cygpath --unix "$JAVACMD" )
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    for arg do
        if
            case $arg in                                #(
              -*)   false ;;                            # don't mess with options #(
              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
                    [ -e "$t" ] ;;                      #(
              *)    false ;;
            esac
        then
            arg=$( cygpath --path --ignore --mixed "$arg" )
        fi
        # Roll the args list around exactly as many times as the number of
        # args, so each arg winds up back in the position where it started, but
        # possibly modified.
        #
        # NB: a `for` loop captures its iteration list before it begins, so
        # changing the positional parameters here affects neither the number of
        # iterations, nor the values presented in `arg`.
        shift                   # remove old arg
        set -- "$@" "$arg"      # push replacement arg
    done
fi
# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
# Collect all arguments for the java command:
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and optsEnvironmentVar are not allowed to contain shell fragments,
#     and any embedded shellness will be escaped.
#   * For example: A user cannot expect ${Hostname} to be expanded, as it is an environment variable and will be
#     treated as '${Hostname}' itself on the command line.
set -- \
        "-Dorg.gradle.appname=$APP_BASE_NAME" \
        -classpath "$CLASSPATH" \
        org.gradle.wrapper.GradleWrapperMain \
        "$@"
# Stop when "xargs" is not available.
if ! command -v xargs >/dev/null 2>&1
then
    die "xargs is not available"
fi
# Use "xargs" to parse quoted args.
#
# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
#
# In Bash we could simply go:
#
#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
#   set -- "${ARGS[@]}" "$@"
#
# but POSIX shell has neither arrays nor command substitution, so instead we
# post-process each arg (as a line of input to sed) to backslash-escape any
# character that might be a shell metacharacter, then use eval to reverse
# that process (while maintaining the separation between arguments), and wrap
# the whole thing up as a single "set" statement.
#
# This will of course break if any of these variables contains a newline or
# an unmatched quote.
#
eval "set -- $(
        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
        xargs -n1 |
        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
        tr '\n' ' '
    )" '"$@"'
exec "$JAVACMD" "$@"
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-9.0-milestone-1-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.CHANGE_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <application
        android:name=".NovelApp"
        android:allowBackup="true"
        android:label="AI创作"
        android:icon="@android:drawable/sym_def_app_icon"
        android:roundIcon="@android:drawable/sym_def_app_icon"
        android:supportsRtl="true"
        android:theme="@style/Theme.NovelApp">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.NovelApp">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
# Keep kotlinx serialization models
-keep class kotlinx.serialization.** { *; }
-dontwarn kotlinx.serialization.**
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("org.jetbrains.kotlin.plugin.serialization")
    id("org.jetbrains.kotlin.plugin.compose")
}
android {
    namespace = "com.buka.novelapp"
    compileSdk = 34
    defaultConfig {
        applicationId = "com.buka.novelapp"
        minSdk = 24
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"
        buildConfigField("String", "API_BASE_URL", "\"http://10.0.2.2:23004/api/v1/\"")
        buildConfigField("int", "API_TIMEOUT_SECONDS", "5000")
    }
    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = "17"
    }
    buildFeatures {
        compose = true
        buildConfig = true
    }
    packaging {
        resources {
            excludes += "/META-INF/{AL2.0,LGPL2.1}"
        }
    }
}
dependencies {
    val composeBom = platform("androidx.compose:compose-bom:2024.06.00")
    implementation(composeBom)
    androidTestImplementation(composeBom)
    implementation("androidx.core:core-ktx:1.13.1")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.8.2")
    implementation("androidx.activity:activity-compose:1.9.1")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.foundation:foundation")
    implementation("androidx.compose.material:material-icons-extended")
    debugImplementation("androidx.compose.ui:ui-tooling")
    implementation("androidx.navigation:navigation-compose:2.7.7")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.8.2")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.8.2")
    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.7.1")
    implementation("com.squareup.okhttp3:okhttp:4.12.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")
    implementation("com.squareup.retrofit2:retrofit:2.11.0")
    implementation("com.squareup.retrofit2:converter-kotlinx-serialization:2.11.0")
    implementation("androidx.datastore:datastore-preferences:1.1.1")
    implementation("com.google.android.material:material:1.12.0")
}
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config cleartextTrafficPermitted="false">
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </base-config>
</network-security-config>
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class BrainstormRequest(
    @SerialName("first_idea") val firstIdea: String,
    @SerialName("num_ideas") val numIdeas: Int = 5,
    @SerialName("creative_style") val creativeStyle: List<String> = emptyList(),
    @SerialName("concept_type") val conceptType: String? = null,
    @SerialName("plot_type") val plotType: String? = null,
    @SerialName("project_id") val projectId: String? = null
)
@Serializable
data class BrainstormResponse(
    val success: Boolean? = null,
    val message: String? = null,
    val data: BrainstormPayload? = null
)
@Serializable
data class BrainstormPayload(
    @SerialName("brainstorm_ideas") val brainstormIdeas: List<String>? = null
)
@Serializable
data class StoryCoreAdvanceRequest(
    @SerialName("project_id") val projectId: String,
    @SerialName("story_core") val storyCore: String,
    @SerialName("leading_quantity") val leadingQuantity: Int = 1
)
@Serializable
data class ProtagonistResponse(
    val success: Boolean,
    val message: String? = null,
    val data: ProtagonistPayload? = null
)
@Serializable
data class ProtagonistPayload(
    @SerialName("leading_brief") val leadingBrief: String? = null
)
@Serializable
data class GenerateResponse(
    val success: Boolean,
    val message: String? = null,
    val content: String? = null,
    val data: GenerateData? = null
)
@Serializable
data class GenerateData(
    @SerialName("project_id") val projectId: String? = null,
    val sequence: String? = null
)
@Serializable
data class SequenceBeatResponse(
    val success: Boolean,
    val message: String? = null,
    val data: SequenceBeatData? = null
)
@Serializable
data class SequenceBeatData(
    @SerialName("sequence_id") val sequenceId: String,
    @SerialName("scene_beats") val sceneBeats: List<String>? = null
)
@Serializable
data class SequenceScriptResponse(
    val success: Boolean,
    val message: String? = null,
    val data: SequenceScriptData? = null
)
@Serializable
data class SequenceScriptData(
    @SerialName("generated_content") val generatedContent: String? = null
)
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class ProjectDto(
    @SerialName("project_id") val projectId: String,
    @SerialName("project_name") val projectName: String,
    val status: String,
    @SerialName("is_favorite") val isFavorite: Boolean? = null,
    val tags: List<String>? = null,
    @SerialName("created_at") val createdAt: String? = null,
    @SerialName("updated_at") val updatedAt: String? = null,
    @SerialName("story_core") val storyCore: String? = null,
    @SerialName("leading_brief") val leadingBrief: String? = null,
    @SerialName("firstIdea") val firstIdea: String? = null,
    @SerialName("first_idea") val firstIdeaLegacy: String? = null,
    @SerialName("brainstorm_ideas") val brainstormIdeas: List<String>? = null,
    val metadata: ProjectMetadataDto? = null
)
@Serializable
data class ProjectMetadataDto(
    @SerialName("word_count") val wordCount: Int? = null,
    @SerialName("chapter_count") val chapterCount: Int? = null,
    @SerialName("character_count") val characterCount: Int? = null
)
@Serializable
data class ProjectsPayload(
    val projects: List<ProjectDto> = emptyList(),
    val pagination: Pagination? = null,
    val total: Int? = null,
    val page: Int? = null,
    val limit: Int? = null
)
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class MultiNarrativeBranchInput(
    @SerialName("branch_title") val branchTitle: String,
    val goal: String? = null,
    val tone: String? = null
)
@Serializable
data class MultiNarrativeRequest(
    @SerialName("project_id") val projectId: String,
    val theme: String,
    val branches: List<MultiNarrativeBranchInput>,
    @SerialName("max_tokens") val maxTokens: Int? = null
)
@Serializable
data class StoryBranchDto(
    @SerialName("branch_title") val branchTitle: String,
    val synopsis: String,
    @SerialName("beat_outline") val beatOutline: List<String>? = null,
    val hook: String? = null
)
@Serializable
data class MultiNarrativePayload(
    val branches: List<StoryBranchDto> = emptyList(),
    @SerialName("token_usage") val tokenUsage: TokenUsageDto? = null
)
@Serializable
data class MultiNarrativeResponse(
    val success: Boolean? = null,
    val message: String? = null,
    val data: MultiNarrativePayload? = null
)
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class RegisterRequest(
    val username: String,
    val email: String,
    val password: String,
    val nickname: String? = null
)
@Serializable
data class PointsBalanceDto(
    @SerialName("user_id") val userId: String,
    @SerialName("total_points") val totalPoints: Int,
    @SerialName("usable_points") val usablePoints: Int,
    @SerialName("frozen_points") val frozenPoints: Int,
    @SerialName("lifetime_earned") val lifetimeEarned: Int,
    @SerialName("lifetime_spent") val lifetimeSpent: Int,
    val level: Int,
    @SerialName("level_name") val levelName: String,
    @SerialName("next_level_points") val nextLevelPoints: Int,
    @SerialName("level_progress") val levelProgress: Double
)
@Serializable
data class PointsTransactionDto(
    val id: String,
    @SerialName("user_id") val userId: String,
    val type: String,
    val amount: Int,
    val reason: String,
    val status: String,
    val description: String? = null,
    @SerialName("created_at") val createdAt: String
)
@Serializable
data class TransactionHistoryDto(
    val transactions: List<PointsTransactionDto> = emptyList()
)
@Serializable
data class PaymentPlanListDto(
    val plans: List<PaymentPlanDto> = emptyList(),
    @SerialName("points_tiers") val pointsTiers: List<PaymentPointsTierDto> = emptyList()
)
@Serializable
data class PaymentPlanDto(
    @SerialName("plan_id") val planId: String,
    val name: String,
    val tier: String,
    @SerialName("tier_label") val tierLabel: String,
    val description: String,
    @SerialName("duration_days") val durationDays: Int,
    @SerialName("points_bonus") val pointsBonus: Int,
    val price: PaymentPriceDto,
    val badge: String? = null,
    val popular: Boolean = false,
    val features: List<String>? = null
)
@Serializable
data class PaymentPointsTierDto(
    val tier: String,
    @SerialName("tier_label") val tierLabel: String,
    val points: Int,
    @SerialName("price_label") val priceLabel: String,
    val multiplier: Double
)
@Serializable
data class PaymentPriceDto(
    @SerialName("amount_formatted") val amountFormatted: String,
    val currency: String
)
@Serializable
data class PaymentOrderViewDto(
    @SerialName("order_no") val orderNo: String,
    @SerialName("plan_name") val planName: String,
    @SerialName("plan_tier") val planTier: String,
    val channel: String,
    val status: String,
    @SerialName("points_bonus") val pointsBonus: Int,
    val amount: PaymentPriceDto
)
@Serializable
data class PaymentCredentialDto(
    val channel: String,
    val display: String,
    @SerialName("alipay_page") val alipayPage: AlipayPageCredentialDto? = null,
    @SerialName("wechat_native") val wechatNative: WechatNativeCredentialDto? = null
)
@Serializable
data class AlipayPageCredentialDto(
    @SerialName("page_url") val pageUrl: String
)
@Serializable
data class WechatNativeCredentialDto(
    @SerialName("code_url") val codeUrl: String
)
@Serializable
data class CreatePaymentOrderDto(
    val order: PaymentOrderViewDto,
    val credential: PaymentCredentialDto
)
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class LoginRequest(
    val username: String,
    val password: String
)
@Serializable
data class LoginResult(
    val token: String,
    @SerialName("expires_at") val expiresAt: String,
    val user: UserDto
)
@Serializable
data class UserDto(
    val id: Int,
    val username: String,
    val email: String? = null,
    val role: String? = null,
    val nickname: String? = null,
    val avatar: String? = null,
    @SerialName("is_approved") val isApproved: Boolean? = null,
    val status: String? = null
)
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
import kotlin.math.ceil
@Serializable
data class TokenUsageDto(
    @SerialName("prompt_tokens") val promptTokens: Int = 0,
    @SerialName("completion_tokens") val completionTokens: Int = 0,
    @SerialName("total_tokens") val totalTokens: Int = 0
)
data class TokenUsageEstimate(
    val promptTokens: Int,
    val completionTokens: Int,
    val totalTokens: Int
)
object TokenEstimator {
    fun estimate(text: String, expectedCompletionTokens: Int = 0): TokenUsageEstimate {
        val normalized = text.trim()
        val prompt = ceil(normalized.length / 4.0).toInt().coerceAtLeast(1)
        val completion = expectedCompletionTokens.coerceAtLeast(0)
        return TokenUsageEstimate(prompt, completion, prompt + completion)
    }
    fun estimateForBranches(theme: String, branches: List<String>, expectedCompletionTokens: Int = 0): TokenUsageEstimate {
        val input = buildString {
            append(theme.trim())
            branches.filter { it.isNotBlank() }.forEach {
                append('\n')
                append(it.trim())
            }
        }
        return estimate(input, expectedCompletionTokens)
    }
}
package com.buka.novelapp.data.model
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class MemoryCompassRequest(
    @SerialName("project_id") val projectId: String,
    val focus: String,
    val anchors: List<String> = emptyList()
)
@Serializable
data class MemoryCompassNode(
    val title: String,
    val summary: String,
    val relation: String? = null
)
@Serializable
data class MemoryCompassPayload(
    val nodes: List<MemoryCompassNode> = emptyList()
)
@Serializable
data class MemoryCompassResponse(
    val success: Boolean? = null,
    val message: String? = null,
    val data: MemoryCompassPayload? = null
)
@Serializable
data class MediaGenerateRequest(
    val prompt: String,
    val style: String? = null,
    @SerialName("seconds") val seconds: Int? = null
)
@Serializable
data class MediaAsset(
    val url: String? = null,
    @SerialName("preview") val preview: String? = null,
    @SerialName("request_id") val requestId: String? = null
)
@Serializable
data class MediaGenerateResponse(
    val success: Boolean? = null,
    val message: String? = null,
    val data: MediaAsset? = null
)
@file:OptIn(InternalSerializationApi::class)
package com.buka.novelapp.data.model
import kotlinx.serialization.InternalSerializationApi
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
@Serializable
data class ApiEnvelope<T>(
    val success: Boolean? = null,
    val message: String? = null,
    val code: Int? = null,
    val data: T? = null
)
@Serializable
data class Pagination(
    val page: Int = 1,
    val limit: Int = 20,
    val total: Int = 0,
    @SerialName("total_pages") val totalPages: Int? = null
)
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="Theme.NovelApp" parent="Theme.Material3.DayNight.NoActionBar">
        <item name="android:statusBarColor">@android:color/transparent</item>
    </style>
</resources>
package com.buka.novelapp
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.lifecycle.viewmodel.compose.viewModel
import com.buka.novelapp.ui.navigation.NovelNavHost
import com.buka.novelapp.ui.theme.NovelTheme
import com.buka.novelapp.ui.viewmodel.ViewModelFactory
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val repository = (application as NovelApp).repository
        setContent {
            NovelTheme {
                Surface(color = MaterialTheme.colorScheme.background) {
                    val factory = remember { ViewModelFactory(repository) }
                    NovelNavHost(factory = factory)
                }
            }
        }
    }
}
package com.buka.novelapp.data.storage
import android.content.Context
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.datastore.preferences.preferencesDataStore
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.firstOrNull
import kotlinx.coroutines.flow.map
private val Context.dataStore by preferencesDataStore("novel_settings")
class AuthStorage(private val context: Context) {
    companion object {
        private val TOKEN_KEY = stringPreferencesKey("auth_token")
    }
    val tokenFlow: Flow<String?> = context.dataStore.data.map { it[TOKEN_KEY] }
    suspend fun getToken(): String? = tokenFlow.firstOrNull()
    suspend fun saveToken(token: String) {
        context.dataStore.edit { prefs ->
            prefs[TOKEN_KEY] = token
        }
    }
    suspend fun clear() {
        context.dataStore.edit { prefs ->
            prefs.remove(TOKEN_KEY)
        }
    }
}
package com.buka.novelapp.data.network
import com.buka.novelapp.BuildConfig
import com.buka.novelapp.data.storage.AuthStorage
import java.util.concurrent.TimeUnit
import kotlinx.serialization.ExperimentalSerializationApi
import kotlinx.serialization.json.Json
import okhttp3.Interceptor
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.kotlinx.serialization.asConverterFactory
class ApiClient(private val authStorage: AuthStorage) {
    @Volatile
    var accessToken: String? = null
        private set
    suspend fun hydrateToken() {
        accessToken = authStorage.getToken()
    }
    fun setToken(token: String?) {
        accessToken = token
    }
    @OptIn(ExperimentalSerializationApi::class)
    private val json = Json {
        ignoreUnknownKeys = true
        encodeDefaults = true
        explicitNulls = false
        isLenient = true
    }
    private val authInterceptor = Interceptor { chain ->
        val builder = chain.request().newBuilder()
        builder.addHeader("Accept", "application/json")
        if (chain.request().header("Content-Type") == null) {
            builder.addHeader("Content-Type", "application/json")
        }
        accessToken?.let {
            builder.addHeader("Authorization", "Bearer $it")
        }
        chain.proceed(builder.build())
    }
    private val logging = HttpLoggingInterceptor().apply {
        level = HttpLoggingInterceptor.Level.BODY
    }
    private val okHttp: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(BuildConfig.API_TIMEOUT_SECONDS.toLong(), TimeUnit.SECONDS)
        .readTimeout(BuildConfig.API_TIMEOUT_SECONDS.toLong(), TimeUnit.SECONDS)
        .writeTimeout(BuildConfig.API_TIMEOUT_SECONDS.toLong(), TimeUnit.SECONDS)
        .addInterceptor(authInterceptor)
        .addInterceptor(logging)
        .build()
    private val retrofit: Retrofit = Retrofit.Builder()
        .baseUrl("https://stage-api.bukabuka.com.cn/api/v1/")
        .client(okHttp)
        .addConverterFactory(json.asConverterFactory("application/json".toMediaType()))
        .build()
    val api: NovelApi = retrofit.create(NovelApi::class.java)
}
package com.buka.novelapp.data.network
import com.buka.novelapp.data.model.ApiEnvelope
import com.buka.novelapp.data.model.BrainstormRequest
import com.buka.novelapp.data.model.BrainstormResponse
import com.buka.novelapp.data.model.CreatePaymentOrderDto
import com.buka.novelapp.data.model.GenerateResponse
import com.buka.novelapp.data.model.LoginRequest
import com.buka.novelapp.data.model.LoginResult
import com.buka.novelapp.data.model.MediaGenerateResponse
import com.buka.novelapp.data.model.MemoryCompassResponse
import com.buka.novelapp.data.model.MultiNarrativeResponse
import com.buka.novelapp.data.model.PaymentPlanListDto
import com.buka.novelapp.data.model.PointsBalanceDto
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.data.model.ProjectsPayload
import com.buka.novelapp.data.model.ProtagonistResponse
import com.buka.novelapp.data.model.RegisterRequest
import com.buka.novelapp.data.model.SequenceBeatResponse
import com.buka.novelapp.data.model.SequenceScriptResponse
import com.buka.novelapp.data.model.StoryCoreAdvanceRequest
import com.buka.novelapp.data.model.TransactionHistoryDto
import com.buka.novelapp.data.model.UserDto
import okhttp3.RequestBody
import retrofit2.http.Body
import retrofit2.http.DELETE
import retrofit2.http.GET
import retrofit2.http.POST
import retrofit2.http.PUT
import retrofit2.http.Path
import retrofit2.http.Query
interface NovelApi {
    @POST("auth/register")
    suspend fun register(@Body body: RegisterRequest): ApiEnvelope<UserDto>
    @POST("auth/login")
    suspend fun login(@Body body: LoginRequest): ApiEnvelope<LoginResult>
    @GET("auth/profile")
    suspend fun profile(): ApiEnvelope<UserDto>
    @GET("projects")
    suspend fun getProjects(
        @Query("page") page: Int = 1,
        @Query("limit") limit: Int = 20,
        @Query("status") status: String? = null,
        @Query("search") search: String? = null,
        @Query("sort_by") sortBy: String? = "updated_at",
        @Query("sort_order") sortOrder: String? = "desc"
    ): ApiEnvelope<ProjectsPayload>
    @POST("projects")
    suspend fun createProject(@Body body: RequestBody): ApiEnvelope<ProjectDto>
    @PUT("projects/{id}")
    suspend fun updateProject(@Path("id") id: String, @Body body: RequestBody): ApiEnvelope<ProjectDto>
    @DELETE("projects/{id}")
    suspend fun deleteProject(@Path("id") id: String): ApiEnvelope<Unit>
    @GET("projects/{id}")
    suspend fun getProject(@Path("id") id: String): ApiEnvelope<ProjectDto>
    @POST("llm/brainstorm")
    suspend fun generateBrainstorm(@Body body: BrainstormRequest): BrainstormResponse
    @POST("projects/{id}/story-core/advance")
    suspend fun advanceStoryCore(@Path("id") id: String, @Body body: StoryCoreAdvanceRequest): ApiEnvelope<Unit>
    @POST("protagonist/generate")
    suspend fun generateProtagonist(
        @Query("project_id") projectId: String,
        @Body body: RequestBody
    ): ProtagonistResponse
    @POST("projects/{id}/generate/supporting")
    suspend fun generateSupporting(@Path("id") id: String): GenerateResponse
    @POST("sequence-act/generate")
    suspend fun generatePlot(@Body body: RequestBody): GenerateResponse
    @POST("sequence-beat/generate")
    suspend fun generateBeats(@Body body: RequestBody): SequenceBeatResponse
    @POST("llm/generate-universal")
    suspend fun generateScripts(@Body body: RequestBody): SequenceScriptResponse
    @POST("llm/multi-narrative")
    suspend fun generateMultiNarrative(@Body body: RequestBody): MultiNarrativeResponse
    @POST("memory/compass")
    suspend fun generateMemoryCompass(@Body body: RequestBody): MemoryCompassResponse
    @POST("media/image/generate")
    suspend fun generateImage(@Body body: RequestBody): MediaGenerateResponse
    @POST("media/video/generate")
    suspend fun generateVideo(@Body body: RequestBody): MediaGenerateResponse
    @GET("points/balance")
    suspend fun getPoints(): ApiEnvelope<PointsBalanceDto>
    @GET("points/transactions")
    suspend fun getPointTransactions(): ApiEnvelope<TransactionHistoryDto>
    @GET("payments/plans")
    suspend fun getPaymentPlans(): ApiEnvelope<PaymentPlanListDto>
    @POST("payments/orders")
    suspend fun createPaymentOrder(@Body body: RequestBody): ApiEnvelope<CreatePaymentOrderDto>
}
package com.buka.novelapp.data.repository
import com.buka.novelapp.data.model.ApiEnvelope
import com.buka.novelapp.data.model.BrainstormRequest
import com.buka.novelapp.data.model.BrainstormResponse
import com.buka.novelapp.data.model.CreatePaymentOrderDto
import com.buka.novelapp.data.model.LoginRequest
import com.buka.novelapp.data.model.LoginResult
import com.buka.novelapp.data.model.MediaGenerateResponse
import com.buka.novelapp.data.model.MultiNarrativeBranchInput
import com.buka.novelapp.data.model.MediaGenerateRequest
import com.buka.novelapp.data.model.MultiNarrativePayload
import com.buka.novelapp.data.model.MultiNarrativeRequest
import com.buka.novelapp.data.model.PaymentPlanListDto
import com.buka.novelapp.data.model.PointsBalanceDto
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.data.model.ProjectsPayload
import com.buka.novelapp.data.model.ProtagonistResponse
import com.buka.novelapp.data.model.RegisterRequest
import com.buka.novelapp.data.model.SequenceBeatResponse
import com.buka.novelapp.data.model.SequenceScriptResponse
import com.buka.novelapp.data.model.StoryCoreAdvanceRequest
import com.buka.novelapp.data.model.TransactionHistoryDto
import com.buka.novelapp.data.model.UserDto
import com.buka.novelapp.data.model.MemoryCompassRequest
import com.buka.novelapp.data.model.MemoryCompassPayload
import com.buka.novelapp.data.network.ApiClient
import com.buka.novelapp.data.network.NovelApi
import com.buka.novelapp.data.storage.AuthStorage
import kotlinx.coroutines.flow.Flow
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.RequestBody
import okhttp3.RequestBody.Companion.toRequestBody
import org.json.JSONArray
import org.json.JSONObject
class NovelRepository(
    private val apiClient: ApiClient,
    private val authStorage: AuthStorage
) {
    private val api: NovelApi = apiClient.api
    private val mediaType = "application/json".toMediaType()
    private val json = Json { ignoreUnknownKeys = true; encodeDefaults = true; explicitNulls = false }
    val tokenFlow: Flow<String?> = authStorage.tokenFlow
    suspend fun bootstrap() {
        apiClient.hydrateToken()
    }
    suspend fun login(username: String, password: String): Result<UserDto> = runCatching {
        val envelope: ApiEnvelope<LoginResult> = api.login(LoginRequest(username, password))
        val data = envelope.data ?: throw IllegalStateException(envelope.message ?: "登录失败")
        authStorage.saveToken(data.token)
        apiClient.setToken(data.token)
        data.user
    }
    suspend fun profile(): Result<UserDto> = runCatching {
        val envelope = api.profile()
        envelope.data ?: throw IllegalStateException("无法获取用户信息")
    }
    suspend fun register(username: String, email: String, password: String, nickname: String?): Result<UserDto> = runCatching {
        val response = api.register(RegisterRequest(username, email, password, nickname))
        response.data ?: throw IllegalStateException(response.message ?: "注册失败")
    }
    suspend fun logout() {
        authStorage.clear()
        apiClient.setToken(null)
    }
    suspend fun fetchProjects(search: String?, status: String?): Result<ProjectsPayload> = runCatching {
        val response = api.getProjects(search = search, status = status)
        response.data ?: throw IllegalStateException("项目列表为空")
    }
    suspend fun createProject(name: String, idea: String?): Result<ProjectDto> = runCatching {
        val payload = mutableMapOf<String, Any>("project_name" to name)
        if (!idea.isNullOrBlank()) {
            payload["first_idea"] = idea
        }
        val body = payload.toRequestBody(mediaType)
        val response = api.createProject(body)
        response.data ?: throw IllegalStateException("创建失败")
    }
    suspend fun updateProject(projectId: String, fields: Map<String, Any?>): Result<ProjectDto> = runCatching {
        val body = fields.toRequestBody(mediaType)
        val response = api.updateProject(projectId, body)
        response.data ?: throw IllegalStateException("更新失败")
    }
    suspend fun deleteProject(projectId: String) {
        api.deleteProject(projectId)
    }
    suspend fun fetchProject(projectId: String): Result<ProjectDto> = runCatching {
        val response = api.getProject(projectId)
        response.data ?: throw IllegalStateException("未找到项目")
    }
    suspend fun generateBrainstorm(request: BrainstormRequest): BrainstormResponse = api.generateBrainstorm(request)
    suspend fun advanceStoryCore(projectId: String, storyCore: String) {
        api.advanceStoryCore(projectId, StoryCoreAdvanceRequest(projectId, storyCore, 1))
    }
    suspend fun generateProtagonist(projectId: String): ProtagonistResponse {
        val payload = mapOf(
            "project_id" to projectId,
            "leading_quantity" to 1
        ).toRequestBody(mediaType)
        return api.generateProtagonist(projectId, payload)
    }
    suspend fun generateSupporting(projectId: String) = api.generateSupporting(projectId)
    suspend fun generatePlot(projectId: String) = api.generatePlot(mapOf("project_id" to projectId).toRequestBody(mediaType))
    suspend fun generateBeats(projectId: String, sequenceId: String) = api.generateBeats(
        mapOf("project_id" to projectId, "sequence_id" to sequenceId).toRequestBody(mediaType)
    )
    suspend fun generateScripts(projectId: String, beats: List<String>): SequenceScriptResponse {
        val variables = JSONObject().apply {
            put("project_id", projectId)
            put("current_seq_beats", JSONArray(beats))
        }
        val metadata = JSONObject(mapOf("project_id" to projectId))
        val root = JSONObject().apply {
            put("template_name", "sequence_scripts")
            put("variables", variables)
            put("metadata", metadata)
        }
        val body = root.toString().toRequestBody(mediaType)
        return api.generateScripts(body)
    }
    suspend fun generateMemoryCompass(projectId: String, focus: String, anchors: List<String>): Result<MemoryCompassPayload> = runCatching {
        val request = MemoryCompassRequest(projectId = projectId, focus = focus, anchors = anchors)
        val body = json.encodeToString(MemoryCompassRequest.serializer(), request).toRequestBody(mediaType)
        val response = api.generateMemoryCompass(body)
        if (response.success == false) throw IllegalStateException(response.message ?: "记忆罗盘生成失败")
        response.data ?: MemoryCompassPayload()
    }
    suspend fun generateImage(prompt: String, style: String?): Result<MediaGenerateResponse> = runCatching {
        val payload = MediaGenerateRequest(prompt = prompt, style = style)
        val body = json.encodeToString(MediaGenerateRequest.serializer(), payload).toRequestBody(mediaType)
        val response = api.generateImage(body)
        if (response.success == false) throw IllegalStateException(response.message ?: "图片生成失败")
        response
    }
    suspend fun generateVideo(prompt: String, seconds: Int): Result<MediaGenerateResponse> = runCatching {
        val payload = MediaGenerateRequest(prompt = prompt, seconds = seconds)
        val body = json.encodeToString(MediaGenerateRequest.serializer(), payload).toRequestBody(mediaType)
        val response = api.generateVideo(body)
        if (response.success == false) throw IllegalStateException(response.message ?: "视频生成失败")
        response
    }
    suspend fun generateMultiNarrative(
        projectId: String,
        theme: String,
        branches: List<MultiNarrativeBranchInput>,
        maxTokens: Int?
    ): Result<MultiNarrativePayload> = runCatching {
        val request = MultiNarrativeRequest(projectId = projectId, theme = theme, branches = branches, maxTokens = maxTokens)
        val body = json.encodeToString(MultiNarrativeRequest.serializer(), request).toRequestBody(mediaType)
        val response = api.generateMultiNarrative(body)
        if (response.success == false) throw IllegalStateException(response.message ?: "多线叙事失败")
        response.data ?: MultiNarrativePayload()
    }
    suspend fun fetchPoints(): Result<PointsBalanceDto> = runCatching {
        val response = api.getPoints()
        response.data ?: throw IllegalStateException("积分数据为空")
    }
    suspend fun fetchTransactions(): Result<TransactionHistoryDto> = runCatching {
        val response = api.getPointTransactions()
        response.data ?: throw IllegalStateException("交易数据为空")
    }
    suspend fun fetchPaymentPlans(): Result<PaymentPlanListDto> = runCatching {
        val response = api.getPaymentPlans()
        response.data ?: throw IllegalStateException("套餐为空")
    }
    suspend fun createPaymentOrder(planId: String, channel: String): Result<CreatePaymentOrderDto> = runCatching {
        val payload = mapOf("plan_id" to planId, "channel" to channel).toRequestBody(mediaType)
        val response = api.createPaymentOrder(payload)
        response.data ?: throw IllegalStateException("订单创建失败")
    }
}
private fun Map<String, Any?>.toRequestBody(mediaType: okhttp3.MediaType) : RequestBody {
    val json = JSONObject()
    forEach { (key, value) ->
        when (value) {
            null -> json.put(key, JSONObject.NULL)
            is Iterable<*> -> json.put(key, JSONArray(value.map { it }))
            else -> json.put(key, value)
        }
    }
    return json.toString().toRequestBody(mediaType)
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.Button
import androidx.compose.material3.Card
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.DropdownMenuItem
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.buka.novelapp.ui.viewmodel.UserCenterViewModel
@Composable
fun ProfileScreen(onLogout: () -> Unit, userCenterViewModel: UserCenterViewModel) {
    LaunchedEffect(true) { userCenterViewModel.refresh() }
    LazyColumn(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(16.dp)) {
        item {
            Card {
                Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    Text("个人中心")
                    Text("管理积分与充值，保持与 Web 一致体验")
                }
            }
        }
        item { PointsCard(userCenterViewModel) }
        item { TransactionsCard(userCenterViewModel) }
        item { RechargeCard(userCenterViewModel) }
        item {
            Button(onClick = onLogout, modifier = Modifier.fillMaxWidth()) {
                Text("退出登录")
            }
        }
    }
}
@Composable
private fun PointsCard(viewModel: UserCenterViewModel) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text("积分概览")
            val points = viewModel.pointsState
            if (points == null) {
                Text("加载中…")
            } else {
                Text("可用积分：${points.usablePoints}")
                Text("等级：${points.levelName}")
            }
            OutlinedButton(onClick = { viewModel.loadPoints() }) {
                Text("刷新")
            }
        }
    }
}
@Composable
private fun TransactionsCard(viewModel: UserCenterViewModel) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text("最近积分流水")
            val list = viewModel.transactions.take(5)
            if (list.isEmpty()) {
                Text("暂无记录")
            } else {
                list.forEach {
                    Row(horizontalArrangement = Arrangement.SpaceBetween, modifier = Modifier.fillMaxWidth()) {
                        Column {
                            Text(it.reason)
                            Text(it.status)
                        }
                        Text(if (it.amount > 0) "+${it.amount}" else "${it.amount}")
                    }
                }
            }
        }
    }
}
@Composable
private fun RechargeCard(viewModel: UserCenterViewModel) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
            Text("充值 / 会员")
            ChannelSelector(viewModel)
            viewModel.plans.forEach { plan ->
                Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {
                    Text(plan.name)
                    Text(plan.description)
                    Button(onClick = { viewModel.createOrder(plan.planId) }) {
                        Text("购买 ${plan.price.amountFormatted}")
                    }
                }
            }
            viewModel.credentialUrl?.let {
                Text("支付宝链接：$it")
            }
            viewModel.qrContent?.let {
                Text("微信扫码链接：$it")
            }
        }
    }
}
@Composable
private fun ChannelSelector(viewModel: UserCenterViewModel) {
    val expanded = remember { mutableStateOf(false) }
    OutlinedButton(onClick = { expanded.value = true }) {
        Text(if (viewModel.selectedChannel == "alipay_page") "支付宝支付" else "微信扫码支付")
    }
    DropdownMenu(expanded = expanded.value, onDismissRequest = { expanded.value = false }) {
        DropdownMenuItem(text = { Text("支付宝页面") }, onClick = {
            viewModel.selectedChannel = "alipay_page"
            expanded.value = false
        })
        DropdownMenuItem(text = { Text("微信扫码") }, onClick = {
            viewModel.selectedChannel = "wechat_native"
            expanded.value = false
        })
    }
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.AutoStories
import androidx.compose.material.icons.filled.Home
import androidx.compose.material.icons.filled.LibraryBooks
import androidx.compose.material.icons.filled.Person
import androidx.compose.material3.NavigationBar
import androidx.compose.material3.NavigationBarItem
import androidx.compose.material3.NavigationBarItemDefaults
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Modifier
import androidx.lifecycle.viewmodel.compose.viewModel
import com.buka.novelapp.ui.viewmodel.CreationStepKind
import com.buka.novelapp.ui.viewmodel.CreationViewModel
import com.buka.novelapp.ui.viewmodel.HomeViewModel
import com.buka.novelapp.ui.viewmodel.MultiNarrativeViewModel
import com.buka.novelapp.ui.viewmodel.MemoryCompassViewModel
import com.buka.novelapp.ui.viewmodel.ProjectsViewModel
import com.buka.novelapp.ui.viewmodel.UserCenterViewModel
import com.buka.novelapp.ui.viewmodel.ViewModelFactory
private enum class MainTab(val label: String) {
    HOME("首页"),
    PROJECTS("项目"),
    CREATION("创作"),
    PROFILE("我的")
}
@Composable
fun MainScreen(factory: ViewModelFactory, onLogout: () -> Unit) {
    val homeViewModel: HomeViewModel = viewModel(factory = factory)
    val projectsViewModel: ProjectsViewModel = viewModel(factory = factory)
    val creationViewModel: CreationViewModel = viewModel(factory = factory)
    val multiNarrativeViewModel: MultiNarrativeViewModel = viewModel(factory = factory)
    val memoryCompassViewModel: MemoryCompassViewModel = viewModel(factory = factory)
    val userCenterViewModel: UserCenterViewModel = viewModel(factory = factory)
    var currentTab by remember { mutableStateOf(MainTab.HOME) }
    LaunchedEffect(Unit) {
        homeViewModel.load()
        projectsViewModel.load()
    }
    Scaffold(
        bottomBar = {
            NavigationBar {
                NavigationBarItem(
                    selected = currentTab == MainTab.HOME,
                    onClick = { currentTab = MainTab.HOME },
                    icon = { androidx.compose.material3.Icon(Icons.Default.Home, contentDescription = null) },
                    label = { Text(MainTab.HOME.label) },
                    colors = NavigationBarItemDefaults.colors()
                )
                NavigationBarItem(
                    selected = currentTab == MainTab.PROJECTS,
                    onClick = { currentTab = MainTab.PROJECTS },
                    icon = { androidx.compose.material3.Icon(Icons.Default.LibraryBooks, contentDescription = null) },
                    label = { Text(MainTab.PROJECTS.label) }
                )
                NavigationBarItem(
                    selected = currentTab == MainTab.CREATION,
                    onClick = { currentTab = MainTab.CREATION },
                    icon = { androidx.compose.material3.Icon(Icons.Default.AutoStories, contentDescription = null) },
                    label = { Text(MainTab.CREATION.label) }
                )
                NavigationBarItem(
                    selected = currentTab == MainTab.PROFILE,
                    onClick = { currentTab = MainTab.PROFILE },
                    icon = { androidx.compose.material3.Icon(Icons.Default.Person, contentDescription = null) },
                    label = { Text(MainTab.PROFILE.label) }
                )
            }
        }
    ) { padding ->
        Column(modifier = Modifier.fillMaxSize().padding(padding)) {
            when (currentTab) {
                MainTab.HOME -> HomeScreen(homeViewModel) {
                    creationViewModel.runStep(CreationStepKind.INSPIRATION)
                }
                MainTab.PROJECTS -> ProjectsScreen(projectsViewModel)
                MainTab.CREATION -> CreationScreen(creationViewModel, multiNarrativeViewModel, memoryCompassViewModel)
                MainTab.PROFILE -> ProfileScreen(onLogout = onLogout, userCenterViewModel = userCenterViewModel)
            }
        }
    }
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.Button
import androidx.compose.material3.Card
import androidx.compose.material3.FilterChip
import androidx.compose.material3.FilterChipDefaults
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.ui.viewmodel.ProjectsViewModel
@Composable
fun ProjectsScreen(viewModel: ProjectsViewModel) {
    LaunchedEffect(Unit) { viewModel.fetchProjects() }
    Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
        OutlinedTextField(
            value = viewModel.search,
            onValueChange = {
                viewModel.updateSearch(it)
                viewModel.fetchProjects()
            },
            label = { Text("搜索项目") },
            modifier = Modifier.fillMaxWidth()
        )
        FilterRow(viewModel)
        OutlinedTextField(
            value = viewModel.newProjectName,
            onValueChange = { viewModel.newProjectName = it },
            label = { Text("新项目名称") },
            modifier = Modifier.fillMaxWidth()
        )
        OutlinedTextField(
            value = viewModel.newProjectIdea,
            onValueChange = { viewModel.newProjectIdea = it },
            label = { Text("灵感 (可选)") },
            modifier = Modifier.fillMaxWidth()
        )
        Button(onClick = { viewModel.createProject() }, enabled = viewModel.newProjectName.isNotBlank()) {
            Text("新建项目")
        }
        LazyColumn(verticalArrangement = Arrangement.spacedBy(12.dp)) {
            items(viewModel.projects) { project ->
                ProjectItem(project, onFavorite = { viewModel.toggleFavorite(project) }) {
                    viewModel.delete(project)
                }
            }
        }
    }
}
@Composable
private fun FilterRow(viewModel: ProjectsViewModel) {
    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
        listOf(null to "全部", "in_progress" to "进行中", "completed" to "已完成", "archived" to "归档")
            .forEach { (value, label) ->
                FilterChip(
                    selected = viewModel.statusFilter == value,
                    onClick = { viewModel.applyStatusFilter(value) },
                    label = { Text(label) },
                    colors = FilterChipDefaults.filterChipColors()
                )
            }
    }
}
@Composable
private fun ProjectItem(project: ProjectDto, onFavorite: () -> Unit, onDelete: () -> Unit) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text(project.projectName)
            Text(project.storyCore ?: "暂无故事核心")
            Row(horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                TextButton(onClick = onFavorite) { Text(if (project.isFavorite == true) "取消收藏" else "收藏") }
                TextButton(onClick = onDelete) { Text("删除") }
            }
        }
    }
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.Button
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.ui.viewmodel.HomeViewModel
@Composable
fun HomeScreen(viewModel: HomeViewModel, onStartCreation: () -> Unit) {
    LazyColumn(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
        item {
            Column {
                Text(text = "欢迎回来", style = MaterialTheme.typography.titleLarge)
                Text(text = "继续你的创作旅程", style = MaterialTheme.typography.bodyMedium)
                Spacer(modifier = Modifier.height(12.dp))
                Button(onClick = { viewModel.load() }) {
                    Text("刷新数据")
                }
            }
        }
        item { StatsSection(viewModel) }
        item { QuickActions(onStart = onStartCreation) }
        item { Text("最新项目", style = MaterialTheme.typography.titleMedium) }
        items(viewModel.projects.take(4)) { ProjectCard(it) }
    }
}
@Composable
private fun StatsSection(viewModel: HomeViewModel) {
    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
        Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.spacedBy(8.dp)) {
            StatCard(
                title = "项目",
                value = viewModel.stats.total.toString(),
                modifier = Modifier.weight(1f)
            )
            StatCard(
                title = "进行中",
                value = viewModel.stats.active.toString(),
                modifier = Modifier.weight(1f)
            )
        }
        Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.spacedBy(8.dp)) {
            StatCard(
                title = "已完成",
                value = viewModel.stats.completed.toString(),
                modifier = Modifier.weight(1f)
            )
            StatCard(
                title = "字数",
                value = "${viewModel.stats.words} 字",
                modifier = Modifier.weight(1f)
            )
        }
    }
}
@Composable
private fun StatCard(title: String, value: String, modifier: Modifier = Modifier) {
    Card(elevation = CardDefaults.cardElevation(defaultElevation = 2.dp), modifier = modifier) {
        Column(modifier = Modifier.padding(16.dp)) {
            Text(title, style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.primary)
            Text(value, style = MaterialTheme.typography.titleLarge)
        }
    }
}
@Composable
private fun QuickActions(onStart: () -> Unit) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text("快速操作", style = MaterialTheme.typography.titleMedium)
            Button(onClick = onStart) { Text("开始生成灵感") }
        }
    }
}
@Composable
private fun ProjectCard(project: ProjectDto) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(4.dp)) {
            Text(project.projectName, style = MaterialTheme.typography.titleMedium)
            Text(project.storyCore ?: "尚未生成", style = MaterialTheme.typography.bodySmall)
        }
    }
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Button
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.unit.dp
import com.buka.novelapp.ui.viewmodel.AuthUiState
@Composable
fun LoginScreen(
    state: AuthUiState,
    onUsernameChange: (String) -> Unit,
    onPasswordChange: (String) -> Unit,
    onEmailChange: (String) -> Unit,
    onNicknameChange: (String) -> Unit,
    onToggleMode: () -> Unit,
    onLogin: () -> Unit,
    onRegister: () -> Unit
) {
    Column(modifier = Modifier.padding(24.dp), verticalArrangement = Arrangement.spacedBy(16.dp)) {
        Text("AI 创作工作台")
        OutlinedTextField(
            value = state.username,
            onValueChange = onUsernameChange,
            label = { Text("用户名") },
            modifier = Modifier.fillMaxWidth()
        )
        OutlinedTextField(
            value = state.password,
            onValueChange = onPasswordChange,
            label = { Text("密码") },
            visualTransformation = PasswordVisualTransformation(),
            modifier = Modifier.fillMaxWidth()
        )
        if (state.isRegisterMode) {
            OutlinedTextField(
                value = state.email,
                onValueChange = onEmailChange,
                label = { Text("邮箱") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = state.nickname,
                onValueChange = onNicknameChange,
                label = { Text("昵称") },
                modifier = Modifier.fillMaxWidth()
            )
        }
        if (state.error != null) {
            Text(state.error, color = androidx.compose.ui.graphics.Color.Red)
        }
        Button(
            onClick = { if (state.isRegisterMode) onRegister() else onLogin() },
            enabled = !state.isLoading,
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(if (state.isRegisterMode) "注册并登录" else "登录")
        }
        TextButton(onClick = onToggleMode) {
            Text(if (state.isRegisterMode) "已有账号？切换登录" else "没有账号？注册")
        }
        TextButton(onClick = onLogin, enabled = !state.isLoading && !state.isRegisterMode) {
            Text("使用示例账号自动登录")
        }
    }
}
package com.buka.novelapp.ui.screen
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material3.Button
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.FilledTonalButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Tab
import androidx.compose.material3.TabRow
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.buka.novelapp.data.model.StoryBranchDto
import com.buka.novelapp.ui.viewmodel.BranchFormState
import com.buka.novelapp.ui.viewmodel.CreationStepKind
import com.buka.novelapp.ui.viewmodel.CreationStepState
import com.buka.novelapp.ui.viewmodel.CreationViewModel
import com.buka.novelapp.ui.viewmodel.MultiNarrativeViewModel
import com.buka.novelapp.ui.viewmodel.MultiNarrativeUiState
import com.buka.novelapp.ui.viewmodel.MemoryCompassViewModel
import com.buka.novelapp.ui.viewmodel.StepStatus
private enum class CreationTab(val label: String) { WORKFLOW("创作流程"), MULTI("多线叙事"), MEMORY("记忆罗盘") }
@Composable
fun CreationScreen(creationViewModel: CreationViewModel, multiNarrativeViewModel: MultiNarrativeViewModel, memoryCompassViewModel: MemoryCompassViewModel) {
    var currentTab by remember { mutableStateOf(CreationTab.WORKFLOW) }
    Column(modifier = Modifier.fillMaxSize()) {
        TabRow(selectedTabIndex = currentTab.ordinal) {
            CreationTab.values().forEach { tab ->
                Tab(selected = currentTab == tab, onClick = { currentTab = tab }, text = { Text(tab.label) })
            }
        }
        when (currentTab) {
            CreationTab.WORKFLOW -> CreationWorkflow(creationViewModel)
            CreationTab.MULTI -> MultiNarrativePanel(multiNarrativeViewModel)
            CreationTab.MEMORY -> MemoryCompassPanel(memoryCompassViewModel)
        }
    }
}
@Composable
private fun CreationWorkflow(viewModel: CreationViewModel) {
    LazyColumn(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(16.dp)) {
        item { ProjectBindingSection(viewModel) }
        item { Text("创作步骤", style = MaterialTheme.typography.titleMedium) }
        items(viewModel.uiState.steps) { step ->
            StepCard(step = step, onRun = { viewModel.runStep(step.kind) })
        }
        item {
            if (viewModel.uiState.script.isNotBlank()) {
                OutputCard(title = "正文输出", content = viewModel.uiState.script)
            }
        }
    }
}
@Composable
private fun ProjectBindingSection(viewModel: CreationViewModel) {
    Card(elevation = CardDefaults.cardElevation(2.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
            OutlinedTextField(
                value = viewModel.uiState.projectId,
                onValueChange = viewModel::updateProjectId,
                label = { Text("项目ID") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = viewModel.uiState.projectName,
                onValueChange = viewModel::updateProjectName,
                label = { Text("项目名称") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = viewModel.uiState.firstIdea,
                onValueChange = viewModel::updateFirstIdea,
                label = { Text("创作灵感") },
                modifier = Modifier.fillMaxWidth()
            )
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                Button(onClick = viewModel::ensureProject) { Text("新建/绑定") }
                OutlinedButton(onClick = viewModel::attachProject) { Text("同步项目") }
            }
            viewModel.uiState.error?.let { Text(it, color = androidx.compose.ui.graphics.Color.Red) }
        }
    }
}
@Composable
private fun StepCard(step: CreationStepState, onRun: () -> Unit) {
    Card(elevation = CardDefaults.cardElevation(1.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text(step.kind.title, style = MaterialTheme.typography.titleMedium)
            Text(step.kind.description, maxLines = 2, overflow = TextOverflow.Ellipsis)
            Text("状态：${step.status.name}")
            if (step.preview.isNotBlank()) {
                Text(step.preview, maxLines = 3, overflow = TextOverflow.Ellipsis)
            }
            Button(onClick = onRun) { Text("执行") }
        }
    }
}
@Composable
private fun OutputCard(title: String, content: String) {
    Card {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Text(title, style = MaterialTheme.typography.titleMedium)
            Text(content)
        }
    }
}
@Composable
private fun MultiNarrativePanel(viewModel: MultiNarrativeViewModel) {
    val state = viewModel.uiState
    LazyColumn(modifier = Modifier.fillMaxSize().padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
        item {
            Text("多线叙事生成与Token预估", style = MaterialTheme.typography.titleMedium)
        }
        item {
            Card(elevation = CardDefaults.cardElevation(1.dp)) {
                Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    OutlinedTextField(
                        value = state.projectId,
                        onValueChange = viewModel::updateProjectId,
                        label = { Text("项目ID（可选，便于关联项目）") },
                        modifier = Modifier.fillMaxWidth()
                    )
                    OutlinedTextField(
                        value = state.theme,
                        onValueChange = viewModel::updateTheme,
                        label = { Text("主题 / 故事核心") },
                        modifier = Modifier.fillMaxWidth()
                    )
                    OutlinedTextField(
                        value = state.targetTokens.toString(),
                        onValueChange = viewModel::updateTargetTokens,
                        label = { Text("预期输出Token上限") },
                        keyboardOptions = KeyboardOptions.Default.copy(keyboardType = KeyboardType.Number),
                        modifier = Modifier.fillMaxWidth()
                    )
                }
            }
        }
        items(state.branches.size) { index ->
            BranchCard(index = index, branch = state.branches[index], onTitleChange = viewModel::updateBranchTitle, onGoalChange = viewModel::updateBranchGoal, onToneChange = viewModel::updateBranchTone, onRemove = viewModel::removeBranch)
        }
        item {
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                OutlinedButton(onClick = viewModel::addBranch) { Text("新增分支") }
                FilledTonalButton(onClick = viewModel::generate, enabled = !state.isLoading) {
                    Text(if (state.isLoading) "生成中…" else "生成多线叙事")
                }
            }
            state.error?.let { Text(it, color = androidx.compose.ui.graphics.Color.Red, modifier = Modifier.padding(top = 8.dp)) }
        }
        item { TokenUsageCard(state) }
        if (state.results.isNotEmpty()) {
            item { Text("生成结果", style = MaterialTheme.typography.titleMedium, modifier = Modifier.padding(top = 4.dp)) }
            items(state.results) { branch ->
                StoryBranchCard(branch)
            }
        }
    }
}
@Composable
private fun BranchCard(
    index: Int,
    branch: BranchFormState,
    onTitleChange: (Int, String) -> Unit,
    onGoalChange: (Int, String) -> Unit,
    onToneChange: (Int, String) -> Unit,
    onRemove: (Int) -> Unit
) {
    Card(elevation = CardDefaults.cardElevation(1.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Row(horizontalArrangement = Arrangement.SpaceBetween, modifier = Modifier.fillMaxWidth()) {
                Text("分支 ${index + 1}", style = MaterialTheme.typography.titleMedium)
                OutlinedButton(onClick = { onRemove(index) }) { Text("移除") }
            }
            OutlinedTextField(
                value = branch.title,
                onValueChange = { onTitleChange(index, it) },
                label = { Text("分支标题") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = branch.goal,
                onValueChange = { onGoalChange(index, it) },
                label = { Text("分支目标 / 冲突") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = branch.tone,
                onValueChange = { onToneChange(index, it) },
                label = { Text("叙事风格 / 口吻") },
                modifier = Modifier.fillMaxWidth()
            )
        }
    }
}
@Composable
private fun TokenUsageCard(state: MultiNarrativeUiState) {
    Card(elevation = CardDefaults.cardElevation(1.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {
            Text("本地预估Token消耗", style = MaterialTheme.typography.titleMedium)
            Text("Prompt: ${state.estimated.promptTokens}，输出预期：${state.estimated.completionTokens}")
            Text("总计: ${state.estimated.totalTokens}")
            state.remoteUsage?.let {
                Spacer(modifier = Modifier.height(8.dp))
                Text("服务端反馈Token", style = MaterialTheme.typography.titleSmall)
                Text("Prompt: ${it.promptTokens}，Completion: ${it.completionTokens}，Total: ${it.totalTokens}")
            }
        }
    }
}
@Composable
private fun MemoryCompassPanel(viewModel: MemoryCompassViewModel) {
    val state = viewModel.uiState
    LazyColumn(modifier = Modifier.fillMaxSize().padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
        item { Text("记忆罗盘 + 影像生成", style = MaterialTheme.typography.titleMedium) }
        item {
            Card(elevation = CardDefaults.cardElevation(1.dp)) {
                Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    OutlinedTextField(
                        value = state.projectId,
                        onValueChange = viewModel::updateProjectId,
                        label = { Text("项目ID（可选）") },
                        modifier = Modifier.fillMaxWidth()
                    )
                    OutlinedTextField(
                        value = state.focus,
                        onValueChange = viewModel::updateFocus,
                        label = { Text("记忆焦点 / 主问题") },
                        modifier = Modifier.fillMaxWidth()
                    )
                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                        OutlinedTextField(
                            value = state.anchorInput,
                            onValueChange = viewModel::updateAnchorInput,
                            label = { Text("锚点关键词") },
                            modifier = Modifier.weight(1f)
                        )
                        OutlinedButton(onClick = viewModel::addAnchor) { Text("添加") }
                    }
                    if (state.anchors.isNotEmpty()) {
                        Text(state.anchors.joinToString("，"), style = MaterialTheme.typography.bodySmall)
                    }
                    Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                        FilledTonalButton(onClick = viewModel::generateCompass, enabled = !state.isLoadingCompass) {
                            Text(if (state.isLoadingCompass) "生成中…" else "生成记忆罗盘")
                        }
                        OutlinedButton(onClick = { if (state.anchorInput.isNotBlank()) viewModel.addAnchor() }) { Text("快捷添加") }
                    }
                    state.compassError?.let { Text(it, color = androidx.compose.ui.graphics.Color.Red) }
                }
            }
        }
        if (state.nodes.isNotEmpty()) {
            item { Text("记忆罗盘节点", style = MaterialTheme.typography.titleMedium) }
            items(state.nodes) { node ->
                Card(elevation = CardDefaults.cardElevation(1.dp)) {
                    Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {
                        Text(node.title, style = MaterialTheme.typography.titleMedium)
                        Text(node.summary)
                        node.relation?.let { Text("关联：$it", style = MaterialTheme.typography.bodySmall) }
                    }
                }
            }
        }
        item { MediaGenerateSection(viewModel) }
    }
}
@Composable
private fun MediaGenerateSection(viewModel: MemoryCompassViewModel) {
    val state = viewModel.uiState
    Card(elevation = CardDefaults.cardElevation(1.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
            Text("图片生成")
            OutlinedTextField(
                value = state.imagePrompt,
                onValueChange = viewModel::updateImagePrompt,
                label = { Text("图片提示词") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = state.imageStyle,
                onValueChange = viewModel::updateImageStyle,
                label = { Text("风格/镜头/色调（可选）") },
                modifier = Modifier.fillMaxWidth()
            )
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                FilledTonalButton(onClick = viewModel::generateImage, enabled = !state.isLoadingImage) {
                    Text(if (state.isLoadingImage) "生成中…" else "生成图片")
                }
                state.imageAsset?.url?.let { Text("URL: $it", style = MaterialTheme.typography.bodySmall) }
            }
            state.imageError?.let { Text(it, color = androidx.compose.ui.graphics.Color.Red) }
            Text("视频生成")
            OutlinedTextField(
                value = state.videoPrompt,
                onValueChange = viewModel::updateVideoPrompt,
                label = { Text("视频提示词") },
                modifier = Modifier.fillMaxWidth()
            )
            OutlinedTextField(
                value = state.videoSeconds.toString(),
                onValueChange = viewModel::updateVideoSeconds,
                label = { Text("时长（3-60秒）") },
                keyboardOptions = KeyboardOptions.Default.copy(keyboardType = KeyboardType.Number),
                modifier = Modifier.fillMaxWidth()
            )
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                FilledTonalButton(onClick = viewModel::generateVideo, enabled = !state.isLoadingVideo) {
                    Text(if (state.isLoadingVideo) "生成中…" else "生成视频")
                }
                state.videoAsset?.url?.let { Text("URL: $it", style = MaterialTheme.typography.bodySmall) }
            }
            state.videoError?.let { Text(it, color = androidx.compose.ui.graphics.Color.Red) }
        }
    }
}
@Composable
private fun StoryBranchCard(branch: StoryBranchDto) {
    Card(elevation = CardDefaults.cardElevation(1.dp)) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(6.dp)) {
            Text(branch.branchTitle, style = MaterialTheme.typography.titleMedium)
            Text(branch.synopsis)
            branch.hook?.let { Text("亮点：$it") }
            branch.beatOutline?.let { beats ->
                if (beats.isNotEmpty()) {
                    Text("节拍纲要：")
                    beats.forEach { Text("- $it") }
                }
            }
        }
    }
}
package com.buka.novelapp.ui.navigation
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavHostController
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import com.buka.novelapp.ui.screen.LoginScreen
import com.buka.novelapp.ui.screen.MainScreen
import com.buka.novelapp.ui.viewmodel.AuthViewModel
import com.buka.novelapp.ui.viewmodel.ViewModelFactory
private const val ROUTE_AUTH = "auth"
private const val ROUTE_MAIN = "main"
@Composable
fun NovelNavHost(factory: ViewModelFactory, navController: NavHostController = rememberNavController()) {
    val authViewModel: AuthViewModel = viewModel(factory = factory)
    val hasToken by authViewModel.hasToken.collectAsStateWithLifecycle()
    val isLoggedIn = hasToken || authViewModel.uiState.user != null
    LaunchedEffect(isLoggedIn) {
        navController.navigate(if (isLoggedIn) ROUTE_MAIN else ROUTE_AUTH) {
            popUpTo(0)
        }
    }
    NavHost(navController = navController, startDestination = if (isLoggedIn) ROUTE_MAIN else ROUTE_AUTH) {
        composable(ROUTE_AUTH) {
            LoginScreen(
                state = authViewModel.uiState,
                onUsernameChange = authViewModel::onUsernameChange,
                onPasswordChange = authViewModel::onPasswordChange,
                onEmailChange = authViewModel::onEmailChange,
                onNicknameChange = authViewModel::onNicknameChange,
                onToggleMode = authViewModel::toggleMode,
                onLogin = authViewModel::login,
                onRegister = authViewModel::register
            )
        }
        composable(ROUTE_MAIN) {
            MainScreen(factory = factory, onLogout = authViewModel::logout)
        }
    }
}
package com.buka.novelapp.ui.theme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color
private val LightColors = lightColorScheme(
    primary = Color(0xFF6750A4),
    secondary = Color(0xFF625B71),
    tertiary = Color(0xFF7D5260)
)
private val DarkColors = darkColorScheme(
    primary = Color(0xFFD0BCFF),
    secondary = Color(0xFFCCC2DC),
    tertiary = Color(0xFFEFB8C8)
)
@Composable
fun NovelTheme(content: @Composable () -> Unit) {
    MaterialTheme(
        colorScheme = LightColors,
        typography = MaterialTheme.typography,
        content = content
    )
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.MultiNarrativeBranchInput
import com.buka.novelapp.data.model.MultiNarrativePayload
import com.buka.novelapp.data.model.StoryBranchDto
import com.buka.novelapp.data.model.TokenEstimator
import com.buka.novelapp.data.model.TokenUsageDto
import com.buka.novelapp.data.model.TokenUsageEstimate
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
data class BranchFormState(
    val title: String = "",
    val goal: String = "",
    val tone: String = ""
)
data class MultiNarrativeUiState(
    val projectId: String = "",
    val theme: String = "",
    val targetTokens: Int = 512,
    val branches: List<BranchFormState> = listOf(
        BranchFormState(title = "主线A"),
        BranchFormState(title = "支线B")
    ),
    val estimated: TokenUsageEstimate = TokenEstimator.estimateForBranches("", emptyList(), 512),
    val remoteUsage: TokenUsageDto? = null,
    val results: List<StoryBranchDto> = emptyList(),
    val isLoading: Boolean = false,
    val error: String? = null
)
class MultiNarrativeViewModel(private val repository: NovelRepository) : ViewModel() {
    var uiState by mutableStateOf(MultiNarrativeUiState())
        private set
    fun updateProjectId(value: String) {
        uiState = uiState.copy(projectId = value)
    }
    fun updateTheme(value: String) {
        updateState { copy(theme = value) }
    }
    fun updateTargetTokens(value: String) {
        val parsed = value.toIntOrNull()?.coerceAtLeast(1) ?: uiState.targetTokens
        updateState { copy(targetTokens = parsed) }
    }
    fun updateBranchTitle(index: Int, value: String) {
        updateBranch(index) { copy(title = value) }
    }
    fun updateBranchGoal(index: Int, value: String) {
        updateBranch(index) { copy(goal = value) }
    }
    fun updateBranchTone(index: Int, value: String) {
        updateBranch(index) { copy(tone = value) }
    }
    fun addBranch() {
        if (uiState.branches.size >= 6) return
        updateState { copy(branches = branches + BranchFormState(title = "分支${branches.size + 1}")) }
    }
    fun removeBranch(index: Int) {
        if (uiState.branches.size <= 1 || index !in uiState.branches.indices) return
        updateState { copy(branches = branches.filterIndexed { i, _ -> i != index }) }
    }
    fun generate() {
        val snapshot = uiState
        val validBranches = snapshot.branches.filter { branchInputString(it).isNotBlank() }
        if (snapshot.theme.isBlank() || validBranches.isEmpty()) {
            uiState = snapshot.copy(error = "请先填写主题和至少一条分支")
            return
        }
        viewModelScope.launch {
            uiState = snapshot.copy(
                isLoading = true,
                error = null,
                results = emptyList(),
                remoteUsage = null,
                estimated = TokenEstimator.estimateForBranches(
                    snapshot.theme,
                    validBranches.map(::branchInputString),
                    snapshot.targetTokens
                )
            )
            val requestBranches = validBranches.map {
                MultiNarrativeBranchInput(
                    branchTitle = it.title.ifBlank { "分支" },
                    goal = it.goal.ifBlank { null },
                    tone = it.tone.ifBlank { null }
                )
            }
            val response = repository.generateMultiNarrative(
                projectId = snapshot.projectId,
                theme = snapshot.theme,
                branches = requestBranches,
                maxTokens = snapshot.targetTokens
            )
            uiState = if (response.isSuccess) {
                val payload: MultiNarrativePayload = response.getOrNull() ?: MultiNarrativePayload()
                val next = uiState.copy(
                    isLoading = false,
                    results = payload.branches,
                    remoteUsage = payload.tokenUsage,
                    error = null
                )
                next.copy(
                    estimated = TokenEstimator.estimateForBranches(
                        next.theme,
                        next.branches.map(::branchInputString),
                        next.targetTokens
                    )
                )
            } else {
                uiState.copy(isLoading = false, error = response.exceptionOrNull()?.message ?: "生成失败")
            }
        }
    }
    private fun updateBranch(index: Int, transform: BranchFormState.() -> BranchFormState) {
        if (index !in uiState.branches.indices) return
        val updated = uiState.branches.mapIndexed { i, branch -> if (i == index) branch.transform() else branch }
        updateState { copy(branches = updated) }
    }
    private fun updateState(modifier: MultiNarrativeUiState.() -> MultiNarrativeUiState) {
        val next = uiState.modifier()
        uiState = next.copy(
            estimated = TokenEstimator.estimateForBranches(
                next.theme,
                next.branches.map(::branchInputString),
                next.targetTokens
            )
        )
    }
}
private fun branchInputString(branch: BranchFormState): String {
    return listOf(branch.title, branch.goal, branch.tone).joinToString(" ").trim()
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.PaymentPlanDto
import com.buka.novelapp.data.model.PaymentPointsTierDto
import com.buka.novelapp.data.model.PaymentPriceDto
import com.buka.novelapp.data.model.PaymentPlanListDto
import com.buka.novelapp.data.model.PointsBalanceDto
import com.buka.novelapp.data.model.PointsTransactionDto
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
class UserCenterViewModel(private val repository: NovelRepository) : ViewModel() {
    var pointsState by mutableStateOf<PointsBalanceDto?>(null)
        private set
    var transactions by mutableStateOf<List<PointsTransactionDto>>(emptyList())
        private set
    var plans by mutableStateOf<List<PaymentPlanDto>>(emptyList())
        private set
    var tiers by mutableStateOf<List<PaymentPointsTierDto>>(emptyList())
        private set
    var selectedChannel by mutableStateOf("alipay_page")
    var credentialUrl by mutableStateOf<String?>(null)
    var qrContent by mutableStateOf<String?>(null)
    var error by mutableStateOf<String?>(null)
    var loading by mutableStateOf(false)
    fun refresh() {
        viewModelScope.launch { loadPoints() }
        viewModelScope.launch { loadTransactions() }
        viewModelScope.launch { loadPlans() }
    }
    fun loadPoints() {
        viewModelScope.launch {
            loading = true
            error = null
            val result = repository.fetchPoints()
            if (result.isSuccess) {
                pointsState = result.getOrNull()
            } else {
                error = result.exceptionOrNull()?.message
            }
            loading = false
        }
    }
    fun loadTransactions() {
        viewModelScope.launch {
            val result = repository.fetchTransactions()
            if (result.isSuccess) {
                transactions = result.getOrNull()?.transactions ?: emptyList()
            }
        }
    }
    fun loadPlans() {
        viewModelScope.launch {
            val result = repository.fetchPaymentPlans()
            if (result.isSuccess) {
                val payload: PaymentPlanListDto? = result.getOrNull()
                plans = payload?.plans ?: emptyList()
                tiers = payload?.pointsTiers ?: emptyList()
            } else {
                error = result.exceptionOrNull()?.message
            }
        }
    }
    fun createOrder(planId: String) {
        viewModelScope.launch {
            loading = true
            error = null
            val result = repository.createPaymentOrder(planId, selectedChannel)
            if (result.isSuccess) {
                val credential = result.getOrNull()?.credential
                credentialUrl = credential?.alipayPage?.pageUrl
                qrContent = credential?.wechatNative?.codeUrl
            } else {
                error = result.exceptionOrNull()?.message
            }
            loading = false
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
class ProjectsViewModel(private val repository: NovelRepository) : ViewModel() {
    var projects by mutableStateOf<List<ProjectDto>>(emptyList())
        private set
    var isLoading by mutableStateOf(false)
        private set
    var error by mutableStateOf<String?>(null)
        private set
    var search by mutableStateOf("")
    var statusFilter by mutableStateOf<String?>(null)
    var newProjectName by mutableStateOf("")
    var newProjectIdea by mutableStateOf("")
    var isCreating by mutableStateOf(false)
    fun load() {
        viewModelScope.launch { fetchProjects() }
    }
    fun updateSearch(value: String) {
        search = value
    }
    fun applyStatusFilter(value: String?) {
        statusFilter = value
        load()
    }
    fun fetchProjects() {
        viewModelScope.launch {
            isLoading = true
            error = null
            val result = repository.fetchProjects(search.takeIf { it.isNotBlank() }, statusFilter)
            if (result.isSuccess) {
                projects = result.getOrNull()?.projects ?: emptyList()
            } else {
                error = result.exceptionOrNull()?.message
            }
            isLoading = false
        }
    }
    fun createProject() {
        if (newProjectName.isBlank()) return
        viewModelScope.launch {
            isCreating = true
            val result = repository.createProject(newProjectName, newProjectIdea)
            if (result.isSuccess) {
                projects = listOf(result.getOrNull()!!) + projects
                newProjectName = ""
                newProjectIdea = ""
            } else {
                error = result.exceptionOrNull()?.message
            }
            isCreating = false
        }
    }
    fun toggleFavorite(project: ProjectDto) {
        viewModelScope.launch {
            val updated = repository.updateProject(project.projectId, mapOf(
                "is_favorite" to !(project.isFavorite ?: false)
            ))
            if (updated.isSuccess) {
                val target = updated.getOrNull()
                projects = projects.map { if (it.projectId == target?.projectId) target else it }
            } else {
                error = updated.exceptionOrNull()?.message
            }
        }
    }
    fun delete(project: ProjectDto) {
        viewModelScope.launch {
            repository.deleteProject(project.projectId)
            projects = projects.filterNot { it.projectId == project.projectId }
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.MediaAsset
import com.buka.novelapp.data.model.MemoryCompassNode
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
data class MemoryCompassUiState(
    val projectId: String = "",
    val focus: String = "",
    val anchorInput: String = "",
    val anchors: List<String> = emptyList(),
    val nodes: List<MemoryCompassNode> = emptyList(),
    val isLoadingCompass: Boolean = false,
    val compassError: String? = null,
    val imagePrompt: String = "",
    val imageStyle: String = "",
    val imageAsset: MediaAsset? = null,
    val isLoadingImage: Boolean = false,
    val imageError: String? = null,
    val videoPrompt: String = "",
    val videoSeconds: Int = 10,
    val videoAsset: MediaAsset? = null,
    val isLoadingVideo: Boolean = false,
    val videoError: String? = null
)
class MemoryCompassViewModel(private val repository: NovelRepository) : ViewModel() {
    var uiState by mutableStateOf(MemoryCompassUiState())
        private set
    fun updateProjectId(value: String) { uiState = uiState.copy(projectId = value) }
    fun updateFocus(value: String) { uiState = uiState.copy(focus = value) }
    fun updateAnchorInput(value: String) { uiState = uiState.copy(anchorInput = value) }
    fun addAnchor() {
        if (uiState.anchorInput.isBlank()) return
        val updated = (uiState.anchors + uiState.anchorInput.trim()).distinct().take(8)
        uiState = uiState.copy(anchors = updated, anchorInput = "")
    }
    fun removeAnchor(anchor: String) {
        uiState = uiState.copy(anchors = uiState.anchors.filterNot { it == anchor })
    }
    fun generateCompass() {
        if (uiState.focus.isBlank()) {
            uiState = uiState.copy(compassError = "请先输入记忆焦点")
            return
        }
        viewModelScope.launch {
            uiState = uiState.copy(isLoadingCompass = true, compassError = null)
            val result = repository.generateMemoryCompass(
                projectId = uiState.projectId.ifBlank { "" },
                focus = uiState.focus,
                anchors = uiState.anchors
            )
            uiState = if (result.isSuccess) {
                uiState.copy(nodes = result.getOrNull()?.nodes ?: emptyList(), isLoadingCompass = false)
            } else {
                uiState.copy(isLoadingCompass = false, compassError = result.exceptionOrNull()?.message)
            }
        }
    }
    fun updateImagePrompt(value: String) { uiState = uiState.copy(imagePrompt = value) }
    fun updateImageStyle(value: String) { uiState = uiState.copy(imageStyle = value) }
    fun generateImage() {
        if (uiState.imagePrompt.isBlank()) {
            uiState = uiState.copy(imageError = "请填写图片提示")
            return
        }
        viewModelScope.launch {
            uiState = uiState.copy(isLoadingImage = true, imageError = null, imageAsset = null)
            val result = repository.generateImage(uiState.imagePrompt, uiState.imageStyle.ifBlank { null })
            uiState = if (result.isSuccess) {
                uiState.copy(isLoadingImage = false, imageAsset = result.getOrNull()?.data)
            } else {
                uiState.copy(isLoadingImage = false, imageError = result.exceptionOrNull()?.message)
            }
        }
    }
    fun updateVideoPrompt(value: String) { uiState = uiState.copy(videoPrompt = value) }
    fun updateVideoSeconds(value: String) {
        val parsed = value.toIntOrNull()?.coerceIn(3, 60) ?: uiState.videoSeconds
        uiState = uiState.copy(videoSeconds = parsed)
    }
    fun generateVideo() {
        if (uiState.videoPrompt.isBlank()) {
            uiState = uiState.copy(videoError = "请填写视频提示")
            return
        }
        viewModelScope.launch {
            uiState = uiState.copy(isLoadingVideo = true, videoError = null, videoAsset = null)
            val result = repository.generateVideo(uiState.videoPrompt, uiState.videoSeconds)
            uiState = if (result.isSuccess) {
                uiState.copy(isLoadingVideo = false, videoAsset = result.getOrNull()?.data)
            } else {
                uiState.copy(isLoadingVideo = false, videoError = result.exceptionOrNull()?.message)
            }
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import com.buka.novelapp.data.repository.NovelRepository
class ViewModelFactory(private val repository: NovelRepository) : ViewModelProvider.Factory {
    @Suppress("UNCHECKED_CAST")
    override fun <T : ViewModel> create(modelClass: Class<T>): T {
        return when {
            modelClass.isAssignableFrom(AuthViewModel::class.java) -> AuthViewModel(repository) as T
            modelClass.isAssignableFrom(HomeViewModel::class.java) -> HomeViewModel(repository) as T
            modelClass.isAssignableFrom(ProjectsViewModel::class.java) -> ProjectsViewModel(repository) as T
            modelClass.isAssignableFrom(CreationViewModel::class.java) -> CreationViewModel(repository) as T
            modelClass.isAssignableFrom(MultiNarrativeViewModel::class.java) -> MultiNarrativeViewModel(repository) as T
            modelClass.isAssignableFrom(MemoryCompassViewModel::class.java) -> MemoryCompassViewModel(repository) as T
            modelClass.isAssignableFrom(UserCenterViewModel::class.java) -> UserCenterViewModel(repository) as T
            else -> throw IllegalArgumentException("Unknown ViewModel: ${modelClass.name}")
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.UserDto
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
data class AuthUiState(
    val username: String = "user001",
    val password: String = "abcd123456",
    val email: String = "user001@example.com",
    val nickname: String = "新用户",
    val isRegisterMode: Boolean = false,
    val isLoading: Boolean = false,
    val error: String? = null,
    val user: UserDto? = null
)
class AuthViewModel(private val repository: NovelRepository) : ViewModel() {
    private val tokenFlow = repository.tokenFlow
    val hasToken: StateFlow<Boolean> = tokenFlow
        .map { !it.isNullOrBlank() }
        .stateIn(viewModelScope, SharingStarted.Eagerly, false)
    var uiState: AuthUiState by mutableStateOf(AuthUiState())
        private set
    init {
        viewModelScope.launch {
            repository.bootstrap()
            refreshProfile()
        }
    }
    fun onUsernameChange(value: String) {
        uiState = uiState.copy(username = value)
    }
    fun onPasswordChange(value: String) {
        uiState = uiState.copy(password = value)
    }
    fun onEmailChange(value: String) {
        uiState = uiState.copy(email = value)
    }
    fun onNicknameChange(value: String) {
        uiState = uiState.copy(nickname = value)
    }
    fun toggleMode() {
        uiState = uiState.copy(isRegisterMode = !uiState.isRegisterMode)
    }
    fun login() {
        viewModelScope.launch {
            uiState = uiState.copy(isLoading = true, error = null)
            val result = repository.login(uiState.username, uiState.password)
            uiState = if (result.isSuccess) {
                uiState.copy(isLoading = false, user = result.getOrNull())
            } else {
                uiState.copy(isLoading = false, error = result.exceptionOrNull()?.message)
            }
        }
    }
    fun register() {
        viewModelScope.launch {
            uiState = uiState.copy(isLoading = true, error = null)
            val result = repository.register(
                uiState.username,
                uiState.email,
                uiState.password,
                uiState.nickname
            )
            if (result.isSuccess) {
                login()
            } else {
                uiState = uiState.copy(isLoading = false, error = result.exceptionOrNull()?.message)
            }
        }
    }
    fun logout() {
        viewModelScope.launch {
            repository.logout()
            uiState = AuthUiState()
        }
    }
    fun refreshProfile() {
        viewModelScope.launch {
            val result = repository.profile()
            if (result.isSuccess) {
                uiState = uiState.copy(user = result.getOrNull(), error = null)
            } else {
                uiState = uiState.copy(error = result.exceptionOrNull()?.message)
            }
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.BrainstormRequest
import com.buka.novelapp.data.model.SequenceBeatResponse
import com.buka.novelapp.data.model.SequenceScriptResponse
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
import org.json.JSONArray
import org.json.JSONException
enum class CreationStepKind(val title: String, val description: String) {
    INSPIRATION("输入灵感", "生成灵感与故事核心"),
    STORY_CORE("故事核心", "深化故事设定"),
    PROTAGONIST("主角人物", "生成主角设定"),
    RELATIONSHIPS("配角关系", "生成配角与关系"),
    PLOT("情节序列", "生成序列与节拍"),
    WRITING("正文生成", "根据节拍生成正文")
}
enum class StepStatus { IDLE, RUNNING, COMPLETED, FAILED }
data class CreationStepState(
    val kind: CreationStepKind,
    val status: StepStatus = StepStatus.IDLE,
    val preview: String = "",
    val updatedAtMillis: Long? = null
)
data class CreationUiState(
    val projectId: String = "",
    val projectName: String = "",
    val firstIdea: String = "",
    val storyCore: String = "",
    val protagonist: String = "",
    val supporting: List<String> = emptyList(),
    val plotSequence: String = "",
    val sceneBeats: List<String> = emptyList(),
    val script: String = "",
    val brainstormIdeas: List<String> = emptyList(),
    val steps: List<CreationStepState> = CreationStepKind.values().map { CreationStepState(it) },
    val error: String? = null,
    val isLoading: Boolean = false
)
class CreationViewModel(private val repository: NovelRepository) : ViewModel() {
    var uiState by mutableStateOf(CreationUiState())
        private set
    fun updateProjectId(value: String) {
        uiState = uiState.copy(projectId = value)
    }
    fun updateProjectName(value: String) {
        uiState = uiState.copy(projectName = value)
    }
    fun updateFirstIdea(value: String) {
        uiState = uiState.copy(firstIdea = value)
    }
    fun attachProject() {
        val id = uiState.projectId
        if (id.isBlank()) return
        viewModelScope.launch {
            uiState = uiState.copy(isLoading = true)
            val result = repository.fetchProject(id)
            uiState = if (result.isSuccess) {
                val project = result.getOrNull()
                uiState.copy(
                    projectName = project?.projectName ?: uiState.projectName,
                    firstIdea = project?.firstIdea ?: project?.firstIdeaLegacy ?: uiState.firstIdea,
                    storyCore = project?.storyCore ?: uiState.storyCore,
                    protagonist = project?.leadingBrief ?: uiState.protagonist,
                    error = null,
                    isLoading = false
                )
            } else {
                uiState.copy(error = result.exceptionOrNull()?.message, isLoading = false)
            }
        }
    }
    fun ensureProject() {
        if (uiState.projectId.isNotBlank()) return
        viewModelScope.launch {
            uiState = uiState.copy(isLoading = true)
            val result = repository.createProject(
                name = if (uiState.projectName.isBlank()) "移动端项目" else uiState.projectName,
                idea = uiState.firstIdea.takeIf { it.isNotBlank() }
            )
            uiState = if (result.isSuccess) {
                val project = result.getOrNull()
                uiState.copy(
                    projectId = project?.projectId ?: uiState.projectId,
                    projectName = project?.projectName ?: uiState.projectName,
                    error = null,
                    isLoading = false
                )
            } else {
                uiState.copy(error = result.exceptionOrNull()?.message, isLoading = false)
            }
        }
    }
    fun runStep(kind: CreationStepKind) {
        viewModelScope.launch {
            if (uiState.projectId.isBlank()) ensureProject()
            updateStep(kind, StepStatus.RUNNING, null)
            when (kind) {
                CreationStepKind.INSPIRATION -> runBrainstorm()
                CreationStepKind.STORY_CORE -> runStoryCore()
                CreationStepKind.PROTAGONIST -> runProtagonist()
                CreationStepKind.RELATIONSHIPS -> runSupporting()
                CreationStepKind.PLOT -> runPlot()
                CreationStepKind.WRITING -> runWriting()
            }
        }
    }
    private suspend fun runBrainstorm() {
        val idea = if (uiState.firstIdea.isBlank()) "请生成一部都市奇幻爱情故事" else uiState.firstIdea
        val response = repository.generateBrainstorm(
            BrainstormRequest(firstIdea = idea, projectId = uiState.projectId.ifBlank { null })
        )
        val ideas = response.data?.brainstormIdeas ?: emptyList()
        uiState = uiState.copy(brainstormIdeas = ideas, storyCore = ideas.firstOrNull() ?: uiState.storyCore)
        if (!uiState.storyCore.isBlank()) {
            repository.advanceStoryCore(uiState.projectId, uiState.storyCore)
        }
        updateStep(CreationStepKind.INSPIRATION, StepStatus.COMPLETED, uiState.storyCore)
    }
    private suspend fun runStoryCore() {
        if (uiState.storyCore.isBlank()) return
        repository.advanceStoryCore(uiState.projectId, uiState.storyCore)
        updateStep(CreationStepKind.STORY_CORE, StepStatus.COMPLETED, uiState.storyCore)
    }
    private suspend fun runProtagonist() {
        val response = repository.generateProtagonist(uiState.projectId)
        val content = response.data?.leadingBrief ?: ""
        if (content.isNotBlank()) {
            uiState = uiState.copy(protagonist = content)
        }
        updateStep(CreationStepKind.PROTAGONIST, StepStatus.COMPLETED, uiState.protagonist)
    }
    private suspend fun runSupporting() {
        val response = repository.generateSupporting(uiState.projectId)
        val characters = parseCharacters(response.content)
        uiState = uiState.copy(supporting = characters)
        updateStep(CreationStepKind.RELATIONSHIPS, StepStatus.COMPLETED, characters.firstOrNull() ?: "")
    }
    private suspend fun runPlot() {
        repository.generatePlot(uiState.projectId)
        val beatResponse: SequenceBeatResponse = repository.generateBeats(uiState.projectId, "seq_main")
        val beats = beatResponse.data?.sceneBeats ?: emptyList()
        uiState = uiState.copy(sceneBeats = beats)
        updateStep(CreationStepKind.PLOT, StepStatus.COMPLETED, beats.firstOrNull() ?: "")
    }
    private suspend fun runWriting() {
        val beats = if (uiState.sceneBeats.isEmpty()) listOf("Scene 1: 引入") else uiState.sceneBeats
        val response: SequenceScriptResponse = repository.generateScripts(uiState.projectId, beats)
        val script = response.data?.generatedContent ?: ""
        uiState = uiState.copy(script = script)
        updateStep(CreationStepKind.WRITING, StepStatus.COMPLETED, script.take(120))
    }
    private fun updateStep(kind: CreationStepKind, status: StepStatus, preview: String?) {
        uiState = uiState.copy(
            steps = uiState.steps.map {
                if (it.kind == kind) {
                    it.copy(status = status, preview = preview ?: it.preview, updatedAtMillis = System.currentTimeMillis())
                } else it
            },
            error = if (status == StepStatus.FAILED) preview else null
        )
    }
    private fun parseCharacters(content: String?): List<String> {
        if (content.isNullOrBlank()) return emptyList()
        return try {
            val array = JSONArray(content)
            (0 until array.length()).mapNotNull { index ->
                val obj = array.optJSONObject(index)
                obj?.let {
                    val name = it.optString("name")
                    val desc = it.optString("description")
                    val relation = it.optString("relationship")
                    "$name - $desc $relation"
                }
            }
        } catch (err: JSONException) {
            content.lines()
        }
    }
}
package com.buka.novelapp.ui.viewmodel
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.buka.novelapp.data.model.ProjectDto
import com.buka.novelapp.data.repository.NovelRepository
import kotlinx.coroutines.launch
data class HomeStats(
    val total: Int = 0,
    val active: Int = 0,
    val completed: Int = 0,
    val words: Int = 0
)
class HomeViewModel(private val repository: NovelRepository) : ViewModel() {
    var stats by mutableStateOf(HomeStats())
        private set
    var projects by mutableStateOf<List<ProjectDto>>(emptyList())
        private set
    var isLoading by mutableStateOf(false)
        private set
    var error by mutableStateOf<String?>(null)
        private set
    fun load() {
        viewModelScope.launch {
            isLoading = true
            error = null
            val result = repository.fetchProjects(search = null, status = null)
            if (result.isSuccess) {
                val payload = result.getOrNull()
                val list = payload?.projects ?: emptyList()
                projects = list
                stats = HomeStats(
                    total = payload?.total ?: list.size,
                    active = list.count { it.status == "in_progress" || it.status == "active" },
                    completed = list.count { it.status == "completed" },
                    words = list.sumOf { it.metadata?.wordCount ?: 0 }
                )
            } else {
                error = result.exceptionOrNull()?.message
            }
            isLoading = false
        }
    }
}
package com.buka.novelapp
import android.app.Application
import com.buka.novelapp.data.network.ApiClient
import com.buka.novelapp.data.repository.NovelRepository
import com.buka.novelapp.data.storage.AuthStorage
class NovelApp : Application() {
    lateinit var repository: NovelRepository
        private set
    override fun onCreate() {
        super.onCreate()
        val authStorage = AuthStorage(applicationContext)
        val apiClient = ApiClient(authStorage)
        repository = NovelRepository(apiClient, authStorage)
    }
}
